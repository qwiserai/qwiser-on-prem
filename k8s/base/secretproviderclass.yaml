# =============================================================================
# QWiser University - SecretProviderClass for Azure Key Vault
# =============================================================================
#
# Uses Secrets Store CSI Driver with Azure Key Vault provider to sync secrets
# from Key Vault into Kubernetes Secrets.
#
# PREREQUISITES:
#   - AKS must have azureKeyvaultSecretsProvider addon enabled (in aks.bicep)
#   - UAMI must have Key Vault Secrets User role on the Key Vault
#   - Key Vault must have secrets: INTERNAL-SECRET-KEY, qwiser-tls-cert (if CSI TLS)
#
# DEPLOYMENT:
#   Run ./apply.sh - it reads KEY_VAULT_URL, UAMI_CLIENT_ID, TENANT_ID from
#   the ConfigMap and substitutes placeholders automatically.
#
# SECRETS SYNCED:
#   1. keda-auth-secret - Contains INTERNAL-SECRET-KEY for KEDA TriggerAuthentication
#   2. qwiser-tls - TLS certificate for NGINX Ingress (if using CSI approach)
#
# TLS NOTES:
#   - If using cert-manager instead of CSI for TLS, remove the qwiser-tls section
#   - The certificate in Key Vault must be in PFX format (Azure exports certs this way)
#   - CSI Driver extracts tls.crt and tls.key from the PFX
#
# =============================================================================

---
# =============================================================================
# SecretProviderClass for KEDA Authentication Secret
# =============================================================================
# Syncs INTERNAL-SECRET-KEY from Key Vault into keda-auth-secret K8s Secret.
# This secret is referenced by TriggerAuthentication in keda.yaml for the
# metrics-api scaler Bearer token.
# =============================================================================

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: keda-auth-provider
  namespace: default
  labels:
    app.kubernetes.io/part-of: qwiser-university
    app.kubernetes.io/component: keda
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "false"
    clientID: REPLACE_WITH_UAMI_CLIENT_ID
    keyvaultName: REPLACE_WITH_KEY_VAULT_NAME
    tenantId: REPLACE_WITH_TENANT_ID
    objects: |
      array:
        - |
          objectName: INTERNAL-SECRET-KEY
          objectType: secret
          objectAlias: internal-secret-key
  secretObjects:
    - secretName: keda-auth-secret
      type: Opaque
      data:
        - objectName: internal-secret-key
          key: internal-secret-key

---
# =============================================================================
# SecretProviderClass for TLS Certificate (CSI Approach)
# =============================================================================
# Syncs TLS certificate from Key Vault into qwiser-tls K8s Secret.
# This secret is referenced by nginx-ingress.yaml for HTTPS termination.
#
# CERTIFICATE REQUIREMENTS:
#   - Must be stored as a Certificate in Key Vault (not just a Secret)
#   - Certificate must cover the custom domain (e.g., qwiser.university.edu)
#   - Certificate can be Azure-managed (from domain verification) or imported
#
# TO USE CERT-MANAGER INSTEAD:
#   1. Delete this SecretProviderClass
#   2. Install cert-manager via Helm
#   3. Create ClusterIssuer for Let's Encrypt
#   4. Add annotation to Ingress: cert-manager.io/cluster-issuer: "letsencrypt-prod"
#   5. cert-manager will create qwiser-tls Secret automatically
#
# =============================================================================

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: tls-cert-provider
  namespace: default
  labels:
    app.kubernetes.io/part-of: qwiser-university
    app.kubernetes.io/component: ingress
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "false"
    clientID: REPLACE_WITH_UAMI_CLIENT_ID
    keyvaultName: REPLACE_WITH_KEY_VAULT_NAME
    tenantId: REPLACE_WITH_TENANT_ID
    objects: |
      array:
        - |
          objectName: qwiser-tls-cert
          objectType: secret
  secretObjects:
    - secretName: qwiser-tls
      type: kubernetes.io/tls
      data:
        - objectName: qwiser-tls-cert
          key: tls.key
        - objectName: qwiser-tls-cert
          key: tls.crt

---
# =============================================================================
# Dummy Pod to Trigger Secret Sync (Required)
# =============================================================================
# CSI Driver only syncs secrets when a Pod mounts the SecretProviderClass.
# This minimal pod exists solely to trigger the sync so that the K8s Secrets
# (keda-auth-secret, qwiser-tls) are created and available for other workloads.
#
# IMPORTANT:
#   - Must run BEFORE other workloads that depend on these secrets
#   - Keeping it running ensures secrets are re-synced if Key Vault values change
#   - Deleting it would delete the synced K8s secrets (CSI driver behavior)
#
# =============================================================================

apiVersion: v1
kind: Pod
metadata:
  name: secrets-sync-trigger
  namespace: default
  labels:
    app: secrets-sync-trigger
    app.kubernetes.io/part-of: qwiser-university
    app.kubernetes.io/component: init
    azure.workload.identity/use: "true"
spec:
  serviceAccountName: sa-qwiser
  containers:
    - name: sync
      image: mcr.microsoft.com/cbl-mariner/base/core:2.0
      command: ["sleep", "infinity"]
      resources:
        requests:
          cpu: "10m"
          memory: "16Mi"
        limits:
          cpu: "50m"
          memory: "32Mi"
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 1000
        capabilities:
          drop:
            - ALL
      volumeMounts:
        - name: keda-secrets
          mountPath: "/mnt/keda-secrets"
          readOnly: true
        - name: tls-secrets
          mountPath: "/mnt/tls-secrets"
          readOnly: true
  volumes:
    - name: keda-secrets
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: keda-auth-provider
    - name: tls-secrets
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: tls-cert-provider
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
