# =============================================================================
# QWiser University - Ingress Configuration
# =============================================================================
#
# Path-based routing for single-domain deployment:
#   /ready, /healthz -> public-api (health checks)
#   /api/*           -> public-api (backend API)
#   /*               -> frontend   (React SPA)
#
# DEPLOYMENT:
#   Run ./apply.sh - it automatically reads CUSTOM_DOMAIN from the ConfigMap
#   created by Bicep and substitutes the placeholder.
#
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: qwiser-ingress
  namespace: default
  annotations:
    # --- Proxy Configuration ---
    nginx.ingress.kubernetes.io/proxy-body-size: "500M"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    # ssl-redirect disabled - Front Door handles TLS termination
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

    # --- Forwarded Headers (from Front Door via NGINX) ---
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"

    # --- WebSocket Support (for smart-quiz, topic-modeling streaming) ---
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$request_uri"

    # --- NOTE: Removed kubernetes.azure.com/tls-cert-keyvault-uri ---
    # That annotation only works with AKS App Routing addon.
    # With vanilla NGINX Ingress Controller, use the TLS section below.

spec:
  # Use NGINX Ingress Controller installed via Helm in Bicep deploymentScript
  ingressClassName: nginx

  # ==========================================================================
  # TLS Configuration
  # ==========================================================================
  # For private AKS with Azure Front Door:
  #   - Front Door terminates TLS (Azure-managed certificate)
  #   - Traffic from Front Door to NGINX Ingress is HTTP over private VNet
  #   - This is secure because the VNet is isolated and Front Door is the only entry point
  #
  # If you need end-to-end TLS (HTTPS from Front Door to NGINX), uncomment below
  # and either:
  #   A) Upload certificate to Key Vault as 'qwiser-tls-cert' (PFX format)
  #   B) Install cert-manager and add annotation: cert-manager.io/cluster-issuer: "letsencrypt-prod"
  #
  # tls:
  #   - hosts:
  #       - REPLACE_WITH_CUSTOM_DOMAIN
  #     secretName: qwiser-tls
  # ==========================================================================

  rules:
    - host: REPLACE_WITH_CUSTOM_DOMAIN
      http:
        paths:
          # --- Health Check Endpoints (highest priority) ---
          # Used by K8s probes and Front Door health probes
          - path: /ready
            pathType: Exact
            backend:
              service:
                name: public-api
                port:
                  number: 8000

          - path: /healthz
            pathType: Exact
            backend:
              service:
                name: public-api
                port:
                  number: 8000

          # --- API Routes (Prefix match) ---
          # All backend API calls go through /api/*
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: public-api
                port:
                  number: 8000

          # --- Frontend Catch-All (lowest priority) ---
          # React SPA served from frontend service
          # NGINX in frontend container handles client-side routing
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 80
