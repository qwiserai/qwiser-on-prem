# =============================================================================
# QWiser University - public-api Deployment Patch
# =============================================================================
#
# Security hardening and configuration for university deployment.
#
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: public-api
  namespace: default
  labels:
    azure.workload.identity/use: "true"
    app: public-api
    app.kubernetes.io/name: qwiser
    app.kubernetes.io/component: public-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: public-api
  template:
    metadata:
      labels:
        app: public-api
        azure.workload.identity/use: "true"
        qwiser-api: "true"
        # REQUIRED: Allows network policy to permit Qdrant access
        qwiser.io/qdrant-access: "true"
    spec:
      serviceAccountName: sa-qwiser

      # --- Pod Security Context ---
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: public-api
          # --- Container Security Context ---
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL

          # Load environment from ConfigMap (created by Bicep deploymentScript)
          envFrom:
            - configMapRef:
                name: qwiser-config

          env:
            # FORWARDED_ALLOW_IPS: Trust proxy headers from NGINX Ingress
            # Using "*" trusts all proxies. This is safe because:
            # 1. NetworkPolicy restricts ingress to only NGINX Ingress controller
            # 2. External traffic cannot reach pods directly (private AKS + Front Door)
            - name: FORWARDED_ALLOW_IPS
              value: "*"
            - name: ENVIRONMENT
              value: "PRODUCTION"
            # Config refresh settings (CONFIG_LABEL comes from ConfigMap)
            - name: CONFIG_REFRESH_INTERVAL
              value: "45"
            - name: CONFIG_SENTINEL_KEY
              value: "sentinel"

          resources:
            requests:
              memory: "2Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "2000m"

          # Health probes require internal auth token
          # Using exec probe with wget to include Authorization header
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - 'wget -q --header="Authorization: Bearer $(cat /mnt/secrets/internal-secret-key)" -O /dev/null http://localhost:8000/ready'
            initialDelaySeconds: 60
            periodSeconds: 15

          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - 'wget -q --header="Authorization: Bearer $(cat /mnt/secrets/internal-secret-key)" -O /dev/null http://localhost:8000/healthz'
            initialDelaySeconds: 120
            periodSeconds: 45
            timeoutSeconds: 40

          # Volume mounts for writable directories (readOnlyRootFilesystem: true)
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: internal-secret
              mountPath: /mnt/secrets
              readOnly: true

      # Volumes for writable directories and secrets
      volumes:
        - name: tmp
          emptyDir: {}
        - name: internal-secret
          secret:
            secretName: keda-auth-secret

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - public-api
                topologyKey: "kubernetes.io/hostname"
