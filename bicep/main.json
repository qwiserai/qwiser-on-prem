{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4114146315558082446"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 10,
      "metadata": {
        "description": "Environment name used for resource naming (e.g., prod, staging)"
      }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "qwiser",
      "minLength": 1,
      "maxLength": 10,
      "metadata": {
        "description": "Base name prefix for all resources"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags to apply to all resources. Example: { Environment: \"prod\", CostCenter: \"IT-12345\", Owner: \"admin@university.edu\" }"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.200.0.0/16",
      "metadata": {
        "description": "Virtual network address space. Uses 10.200.x.x range to minimize overlap with common enterprise networks. Change if this conflicts with existing campus or Azure networks."
      }
    },
    "peSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.200.0.0/24",
      "metadata": {
        "description": "Subnet for private endpoints (Azure PaaS services connect here via Private Link). Currently uses ~11 IPs for private endpoints and Private Link Service NAT."
      }
    },
    "aksNodesSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.200.4.0/22",
      "metadata": {
        "description": "Subnet for AKS worker nodes. Size /22 provides 1024 IPs to support cluster autoscaling."
      }
    },
    "aciSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.200.8.0/27",
      "metadata": {
        "description": "Subnet for deployment scripts (temporary containers used during infrastructure setup). Requires Azure Container Instances delegation."
      }
    },
    "storageAllowSharedKeyAccess": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Allow shared key access on storage account (true = simpler IT uploads, false = Entra ID only)"
      }
    },
    "mysqlAdminLogin": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "MySQL administrator login name"
      }
    },
    "mysqlAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "MySQL administrator password"
      }
    },
    "mysqlSkuTier": {
      "type": "string",
      "defaultValue": "GeneralPurpose",
      "allowedValues": [
        "Burstable",
        "GeneralPurpose",
        "MemoryOptimized"
      ],
      "metadata": {
        "description": "MySQL SKU tier"
      }
    },
    "mysqlSkuName": {
      "type": "string",
      "defaultValue": "Standard_D2ds_v4",
      "metadata": {
        "description": "MySQL SKU name"
      }
    },
    "mysqlStorageSizeGB": {
      "type": "int",
      "defaultValue": 64,
      "metadata": {
        "description": "MySQL storage size in GB"
      }
    },
    "mysqlHighAvailabilityMode": {
      "type": "string",
      "defaultValue": "Disabled",
      "allowedValues": [
        "Disabled",
        "SameZone",
        "ZoneRedundant"
      ],
      "metadata": {
        "description": "MySQL high availability mode (Burstable tier does not support HA)"
      }
    },
    "redisSkuName": {
      "type": "string",
      "defaultValue": "Balanced_B5",
      "allowedValues": [
        "Balanced_B0",
        "Balanced_B1",
        "Balanced_B3",
        "Balanced_B5",
        "Balanced_B10",
        "Balanced_B20",
        "Balanced_B50",
        "Balanced_B100"
      ],
      "metadata": {
        "description": "Redis SKU name. Balanced tier recommended for QWiser workloads."
      }
    },
    "redisHighAvailability": {
      "type": "string",
      "defaultValue": "Enabled",
      "allowedValues": [
        "Enabled",
        "Disabled"
      ],
      "metadata": {
        "description": "Enable Redis high availability"
      }
    },
    "redisZones": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Redis availability zones for zone redundancy"
      }
    },
    "kubernetesVersion": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Kubernetes version (leave empty for latest stable)"
      }
    },
    "aksEnablePrivateCluster": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable private cluster mode (API server not publicly accessible)"
      }
    },
    "aksAuthorizedIPRanges": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Authorized IP ranges for API server access (ignored if private cluster)"
      }
    },
    "aksSystemNodeVmSize": {
      "type": "string",
      "defaultValue": "Standard_D4s_v5",
      "metadata": {
        "description": "AKS system node pool VM size"
      }
    },
    "aksSystemNodeCount": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "AKS system node pool initial node count"
      }
    },
    "aksSystemNodeMinCount": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "AKS system node pool min count for autoscaling"
      }
    },
    "aksSystemNodeMaxCount": {
      "type": "int",
      "defaultValue": 10,
      "metadata": {
        "description": "AKS system node pool max count for autoscaling"
      }
    },
    "aksPodCidr": {
      "type": "string",
      "defaultValue": "100.64.0.0/16",
      "metadata": {
        "description": "Pod CIDR for Azure CNI Overlay. Uses CGNAT range (100.64.x.x) which is unlikely to conflict with campus networks. Only change if your network already uses this range."
      }
    },
    "deployGpuNodePool": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy GPU node pool for embeddings-worker. Required - embeddings fail without GPU acceleration."
      }
    },
    "gpuNodeVmSize": {
      "type": "string",
      "defaultValue": "Standard_NC4as_T4_v3",
      "metadata": {
        "description": "GPU node pool VM size"
      }
    },
    "nginxIngressPrivateIp": {
      "type": "string",
      "defaultValue": "10.200.4.250",
      "metadata": {
        "description": "Static private IP for NGINX Ingress internal LoadBalancer (must be in AKS nodes subnet range)"
      }
    },
    "enableWaf": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Web Application Firewall on Front Door"
      }
    },
    "wafMode": {
      "type": "string",
      "defaultValue": "Prevention",
      "allowedValues": [
        "Detection",
        "Prevention"
      ],
      "metadata": {
        "description": "WAF mode (Detection for testing, Prevention for production)"
      }
    },
    "workloadNamespace": {
      "type": "string",
      "defaultValue": "default",
      "metadata": {
        "description": "Kubernetes namespace for QWiser workloads (federated credentials bound to this namespace)"
      }
    },
    "customDomain": {
      "type": "string",
      "metadata": {
        "description": "Custom domain that university will point to Front Door (e.g., qwiser.university.edu). Used for ConfigMap URL env vars."
      }
    }
  },
  "variables": {
    "location": "[deployment().location]",
    "resourceGroupName": "[format('{0}-{1}-rg', parameters('namePrefix'), parameters('environmentName'))]",
    "namingPrefix": "[format('{0}-{1}', parameters('namePrefix'), parameters('environmentName'))]",
    "aksClusterName": "[format('{0}-aks', variables('namingPrefix'))]",
    "uniqueSuffix": "[substring(uniqueString(subscription().subscriptionId, variables('resourceGroupName')), 0, 6)]",
    "nodeResourceGroupName": "[format('MC_{0}_{1}_{2}', variables('resourceGroupName'), variables('aksClusterName'), variables('location'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[variables('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2024-01-01",
      "name": "Containers",
      "properties": {
        "pricingTier": "Standard",
        "extensions": [
          {
            "name": "ContainerSensor",
            "isEnabled": "True"
          },
          {
            "name": "ContainerRegistriesVulnerabilityAssessments",
            "isEnabled": "True"
          },
          {
            "name": "AgentlessDiscoveryForKubernetes",
            "isEnabled": "True"
          }
        ]
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-vnet",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('vnetAddressPrefix')]"
          },
          "peSubnetPrefix": {
            "value": "[parameters('peSubnetPrefix')]"
          },
          "aksNodesSubnetPrefix": {
            "value": "[parameters('aksNodesSubnetPrefix')]"
          },
          "aciSubnetPrefix": {
            "value": "[parameters('aciSubnetPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16153028900246961662"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "VNet address space CIDR"
              }
            },
            "peSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet CIDR"
              }
            },
            "aksNodesSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "AKS nodes subnet CIDR"
              }
            },
            "aciSubnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "ACI subnet CIDR (delegated)"
              }
            }
          },
          "variables": {
            "vnetName": "[format('{0}-vnet', parameters('namingPrefix'))]",
            "peNsgName": "[format('{0}-pe-nsg', parameters('namingPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-05-01",
              "name": "[variables('peNsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": []
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-05-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "pe-subnet",
                    "properties": {
                      "addressPrefix": "[parameters('peSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('peNsgName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Disabled"
                    }
                  },
                  {
                    "name": "aks-nodes",
                    "properties": {
                      "addressPrefix": "[parameters('aksNodesSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled"
                    }
                  },
                  {
                    "name": "aci-scripts",
                    "properties": {
                      "addressPrefix": "[parameters('aciSubnetPrefix')]",
                      "delegations": [
                        {
                          "name": "Microsoft.ContainerInstance.containerGroups",
                          "properties": {
                            "serviceName": "Microsoft.ContainerInstance/containerGroups"
                          }
                        }
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('peNsgName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "VNet resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "VNet name"
              },
              "value": "[variables('vnetName')]"
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-05-01').subnets[0].id]"
            },
            "aksNodesSubnetId": {
              "type": "string",
              "metadata": {
                "description": "AKS nodes subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-05-01').subnets[1].id]"
            },
            "aciSubnetId": {
              "type": "string",
              "metadata": {
                "description": "ACI scripts subnet resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2024-05-01').subnets[2].id]"
            },
            "peNsgId": {
              "type": "string",
              "metadata": {
                "description": "PE NSG resource ID"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('peNsgName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-private-dns-zones",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "vnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.vnetId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4622126845761893264"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region (used for AKS private DNS zone name)"
              }
            },
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "VNet resource ID to link DNS zones to"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.mysql.database.azure.com",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.redis.azure.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.vaultcore.azure.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.azconfig.io",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.blob.core.windows.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.queue.core.windows.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.file.core.windows.net",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "[format('privatelink.{0}.azmk8s.io', parameters('location'))]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2024-06-01",
              "name": "privatelink.azurecr.io",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.mysql.database.azure.com', 'mysql-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.mysql.database.azure.com')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.redis.azure.net', 'redis-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.redis.azure.net')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.vaultcore.azure.net', 'keyvault-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.azconfig.io', 'appconfig-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azconfig.io')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.blob.core.windows.net', 'blob-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.blob.core.windows.net')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.queue.core.windows.net', 'queue-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.queue.core.windows.net')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.file.core.windows.net', 'file-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.file.core.windows.net')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', format('privatelink.{0}.azmk8s.io', parameters('location')), 'aks-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.{0}.azmk8s.io', parameters('location')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2024-06-01",
              "name": "[format('{0}/{1}', 'privatelink.azurecr.io', 'acr-vnet-link')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azurecr.io')]"
              ]
            }
          ],
          "outputs": {
            "mysqlDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "MySQL private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.mysql.database.azure.com')]"
            },
            "redisDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Azure Managed Redis private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.redis.azure.net')]"
            },
            "keyVaultDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
            },
            "appConfigDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "App Configuration private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azconfig.io')]"
            },
            "blobDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Blob Storage private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.blob.core.windows.net')]"
            },
            "queueDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Queue Storage private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.queue.core.windows.net')]"
            },
            "fileDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Azure Files private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.file.core.windows.net')]"
            },
            "aksDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "AKS private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', format('privatelink.{0}.azmk8s.io', parameters('location')))]"
            },
            "acrDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "ACR private DNS zone resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.azurecr.io')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-managed-identity",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "aksNodesSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.aksNodesSubnetId.value]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "aksDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.aksDnsZoneId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "153140100132916537"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "aksNodesSubnetId": {
              "type": "string",
              "metadata": {
                "description": "AKS nodes subnet resource ID (for Network Contributor role)"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID (for Network Contributor role)"
              }
            },
            "aksDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "AKS private DNS zone resource ID (for Private DNS Zone Contributor role)"
              }
            }
          },
          "variables": {
            "identityName": "[format('{0}-identity', parameters('namingPrefix'))]",
            "networkContributorRoleId": "4d97b98b-1d4f-4787-a291-c67834d212e7",
            "privateDnsZoneContributorRoleId": "b12aa53e-6015-4669-85d0-8515ebb3ae7f",
            "aksVnetName": "[split(parameters('aksNodesSubnetId'), '/')[8]]",
            "peVnetName": "[split(parameters('peSubnetId'), '/')[8]]",
            "aksDnsZoneName": "[last(split(parameters('aksDnsZoneId'), '/'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2024-11-30",
              "name": "[variables('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', variables('aksVnetName'), last(split(parameters('aksNodesSubnetId'), '/')))]",
              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), parameters('aksNodesSubnetId'), variables('networkContributorRoleId'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2024-11-30').principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('networkContributorRoleId'))]",
                "principalType": "ServicePrincipal",
                "description": "Allow managed identity to manage ILB in AKS nodes subnet"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/virtualNetworks/{0}/subnets/{1}', variables('peVnetName'), last(split(parameters('peSubnetId'), '/')))]",
              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), parameters('peSubnetId'), variables('networkContributorRoleId'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2024-11-30').principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('networkContributorRoleId'))]",
                "principalType": "ServicePrincipal",
                "description": "Allow managed identity to allocate PLS NAT IPs in PE subnet"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Network/privateDnsZones/{0}', variables('aksDnsZoneName'))]",
              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), parameters('aksDnsZoneId'), variables('privateDnsZoneContributorRoleId'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2024-11-30').principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('privateDnsZoneContributorRoleId'))]",
                "principalType": "ServicePrincipal",
                "description": "Allow managed identity to manage DNS records in AKS private DNS zone"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
              ]
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity resource ID"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity principal ID (object ID)"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2024-11-30').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity client ID (application ID)"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2024-11-30').clientId]"
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Managed identity name"
              },
              "value": "[variables('identityName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-keyvault",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.keyVaultDnsZoneId.value]"
          },
          "workloadIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7330312960371217765"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique Key Vault name"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault private DNS zone resource ID"
              }
            },
            "workloadIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Workload identity principal ID (for Secrets User role)"
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 7,
              "maxValue": 90,
              "metadata": {
                "description": "Soft delete retention in days (7-90)"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('{0}-kv-{1}', parameters('namingPrefix'), parameters('uniqueSuffix'))]",
            "privateEndpointName": "[format('{0}-kv-pe', parameters('namingPrefix'))]",
            "keyVaultSecretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-11-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "publicNetworkAccess": "Disabled",
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "enablePurgeProtection": true,
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices",
                  "ipRules": [],
                  "virtualNetworkRules": []
                }
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('privateEndpointName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-vaultcore-azure-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), parameters('workloadIdentityPrincipalId'), variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "principalId": "[parameters('workloadIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsUserRoleId'))]",
                "principalType": "ServicePrincipal",
                "description": "Allow workload identity to read secrets from Key Vault"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              },
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI (for App Config references)"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2024-11-01').vaultUri]"
            },
            "privateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-appconfig",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.appConfigDnsZoneId.value]"
          },
          "workloadIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14433091010222730169"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "App Configuration private DNS zone resource ID"
              }
            },
            "workloadIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Workload identity principal ID (for Data Reader role)"
              }
            }
          },
          "variables": {
            "appConfigName": "[format('{0}-appconfig', parameters('namingPrefix'))]",
            "privateEndpointName": "[format('{0}-appconfig-pe', parameters('namingPrefix'))]",
            "appConfigDataReaderRoleId": "516239f1-63e1-4d78-a4de-a74fb236a071"
          },
          "resources": [
            {
              "type": "Microsoft.AppConfiguration/configurationStores",
              "apiVersion": "2024-05-01",
              "name": "[variables('appConfigName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicNetworkAccess": "Disabled",
                "disableLocalAuth": true,
                "enablePurgeProtection": true,
                "softDeleteRetentionInDays": 7
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('privateEndpointName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.AppConfiguration/configurationStores', variables('appConfigName'))]",
                      "groupIds": [
                        "configurationStores"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.AppConfiguration/configurationStores', variables('appConfigName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azconfig-io",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.AppConfiguration/configurationStores/{0}', variables('appConfigName'))]",
              "name": "[guid(resourceId('Microsoft.AppConfiguration/configurationStores', variables('appConfigName')), parameters('workloadIdentityPrincipalId'), variables('appConfigDataReaderRoleId'))]",
              "properties": {
                "principalId": "[parameters('workloadIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('appConfigDataReaderRoleId'))]",
                "principalType": "ServicePrincipal",
                "description": "Allow workload identity to read configuration from App Configuration"
              },
              "dependsOn": [
                "[resourceId('Microsoft.AppConfiguration/configurationStores', variables('appConfigName'))]"
              ]
            }
          ],
          "outputs": {
            "appConfigId": {
              "type": "string",
              "metadata": {
                "description": "App Configuration resource ID"
              },
              "value": "[resourceId('Microsoft.AppConfiguration/configurationStores', variables('appConfigName'))]"
            },
            "appConfigName": {
              "type": "string",
              "metadata": {
                "description": "App Configuration name"
              },
              "value": "[variables('appConfigName')]"
            },
            "appConfigEndpoint": {
              "type": "string",
              "metadata": {
                "description": "App Configuration endpoint (for AZURE_APP_CONFIG_ENDPOINT env var)"
              },
              "value": "[reference(resourceId('Microsoft.AppConfiguration/configurationStores', variables('appConfigName')), '2024-05-01').endpoint]"
            },
            "privateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-storage-account",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "blobDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.blobDnsZoneId.value]"
          },
          "queueDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.queueDnsZoneId.value]"
          },
          "fileDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.fileDnsZoneId.value]"
          },
          "allowSharedKeyAccess": {
            "value": "[parameters('storageAllowSharedKeyAccess')]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.keyVaultName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11519701216347558439"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID"
              }
            },
            "blobDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Blob Storage private DNS zone resource ID"
              }
            },
            "queueDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Queue Storage private DNS zone resource ID"
              }
            },
            "fileDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Azure Files private DNS zone resource ID"
              }
            },
            "allowSharedKeyAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Allow shared key access for IT admin uploads (true = simpler, false = more secure)"
              }
            },
            "mlModelsShareName": {
              "type": "string",
              "defaultValue": "ml-models",
              "metadata": {
                "description": "Name of the Azure Files share for ML models"
              }
            },
            "mlModelsShareQuotaGiB": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "maxValue": 5120,
              "metadata": {
                "description": "Quota for ML models file share in GB"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for storing secrets (if provided, secrets are created)"
              }
            }
          },
          "variables": {
            "storageAccountName": "[toLower(replace(format('{0}storage', parameters('namingPrefix')), '-', ''))]",
            "blobPeName": "[format('{0}-storage-blob-pe', parameters('namingPrefix'))]",
            "queuePeName": "[format('{0}-storage-queue-pe', parameters('namingPrefix'))]",
            "filePeName": "[format('{0}-storage-file-pe', parameters('namingPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2025-01-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "StorageV2",
              "sku": {
                "name": "Standard_LRS"
              },
              "properties": {
                "publicNetworkAccess": "Disabled",
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices",
                  "ipRules": [],
                  "virtualNetworkRules": []
                },
                "allowBlobPublicAccess": false,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowSharedKeyAccess": "[parameters('allowSharedKeyAccess')]",
                "accessTier": "Hot",
                "allowCrossTenantReplication": false
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2025-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2025-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', parameters('mlModelsShareName'))]",
              "properties": {
                "shareQuota": "[parameters('mlModelsShareQuotaGiB')]",
                "enabledProtocols": "SMB",
                "accessTier": "Hot"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('blobPeName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('blobPeName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                      "groupIds": [
                        "blob"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('blobPeName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-blob-core-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('blobDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('blobPeName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('queuePeName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('queuePeName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                      "groupIds": [
                        "queue"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('queuePeName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-queue-core-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('queueDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('queuePeName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('filePeName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('filePeName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                      "groupIds": [
                        "file"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('filePeName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-file-core-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('fileDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('filePeName'))]"
              ]
            },
            {
              "condition": "[and(not(empty(parameters('keyVaultName'))), parameters('allowSharedKeyAccess'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2024-11-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'STORAGE-ACCOUNT-KEY')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2025-01-01').keys[0].value]",
                "contentType": "text/plain"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "condition": "[and(not(empty(parameters('keyVaultName'))), parameters('allowSharedKeyAccess'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2024-11-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'STORAGE-CONNECTION-STRING')]",
              "properties": {
                "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', variables('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2025-01-01').keys[0].value, environment().suffixes.storage)]",
                "contentType": "text/plain"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource ID"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[variables('storageAccountName')]"
            },
            "blobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Blob service primary endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2025-01-01').primaryEndpoints.blob]"
            },
            "queueEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Queue service primary endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2025-01-01').primaryEndpoints.queue]"
            },
            "fileEndpoint": {
              "type": "string",
              "metadata": {
                "description": "File service primary endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2025-01-01').primaryEndpoints.file]"
            },
            "mlModelsShareName": {
              "type": "string",
              "metadata": {
                "description": "ML models file share name"
              },
              "value": "[parameters('mlModelsShareName')]"
            },
            "storageAccountResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource group (for PV configuration)"
              },
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-acr",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.acrDnsZoneId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17952138984723028420"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "ACR private DNS zone resource ID"
              }
            }
          },
          "variables": {
            "acrName": "[toLower(replace(format('{0}acr', parameters('namingPrefix')), '-', ''))]",
            "privateEndpointName": "[format('{0}-acr-pe', parameters('namingPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2025-04-01",
              "name": "[variables('acrName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Premium"
              },
              "properties": {
                "publicNetworkAccess": "Disabled",
                "networkRuleSet": {
                  "defaultAction": "Deny",
                  "ipRules": []
                },
                "anonymousPullEnabled": false,
                "adminUserEnabled": false,
                "zoneRedundancy": "Disabled",
                "dataEndpointEnabled": false
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('privateEndpointName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]",
                      "groupIds": [
                        "registry"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azurecr-io",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "acrId": {
              "type": "string",
              "metadata": {
                "description": "ACR resource ID"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]"
            },
            "acrName": {
              "type": "string",
              "metadata": {
                "description": "ACR name"
              },
              "value": "[variables('acrName')]"
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "ACR login server (e.g., myacr.azurecr.io)"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2025-04-01').loginServer]"
            },
            "privateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-mysql",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.mysqlDnsZoneId.value]"
          },
          "administratorLogin": {
            "value": "[parameters('mysqlAdminLogin')]"
          },
          "administratorLoginPassword": {
            "value": "[parameters('mysqlAdminPassword')]"
          },
          "skuTier": {
            "value": "[parameters('mysqlSkuTier')]"
          },
          "skuName": {
            "value": "[parameters('mysqlSkuName')]"
          },
          "storageSizeGB": {
            "value": "[parameters('mysqlStorageSizeGB')]"
          },
          "highAvailabilityMode": {
            "value": "[parameters('mysqlHighAvailabilityMode')]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.keyVaultName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12880417484094005936"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "MySQL private DNS zone resource ID"
              }
            },
            "administratorLogin": {
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "MySQL administrator login name"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "metadata": {
                "description": "MySQL administrator password"
              }
            },
            "mysqlVersion": {
              "type": "string",
              "defaultValue": "8.0.21",
              "allowedValues": [
                "5.7",
                "8.0.21"
              ],
              "metadata": {
                "description": "MySQL version"
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "GeneralPurpose",
              "allowedValues": [
                "Burstable",
                "GeneralPurpose",
                "MemoryOptimized"
              ],
              "metadata": {
                "description": "SKU tier: Burstable (B-series), GeneralPurpose (D-series), or MemoryOptimized (E-series). Burstable does NOT support HA."
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_D2ds_v4",
              "metadata": {
                "description": "SKU name must match tier: B* for Burstable, D* for GeneralPurpose, E* for MemoryOptimized."
              }
            },
            "storageSizeGB": {
              "type": "int",
              "defaultValue": 64,
              "minValue": 20,
              "maxValue": 16384,
              "metadata": {
                "description": "Storage size in GB"
              }
            },
            "highAvailabilityMode": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Disabled",
                "SameZone",
                "ZoneRedundant"
              ],
              "metadata": {
                "description": "High availability mode"
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "defaultValue": 14,
              "minValue": 1,
              "maxValue": 35,
              "metadata": {
                "description": "Backup retention period in days"
              }
            },
            "geoRedundantBackup": {
              "type": "string",
              "defaultValue": "Disabled",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "description": "Enable geo-redundant backup"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for storing credentials (if provided, secrets are created)"
              }
            }
          },
          "variables": {
            "mysqlServerName": "[format('{0}-mysql', parameters('namingPrefix'))]",
            "privateEndpointName": "[format('{0}-mysql-pe', parameters('namingPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DBforMySQL/flexibleServers",
              "apiVersion": "2024-12-30",
              "name": "[variables('mysqlServerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "version": "[parameters('mysqlVersion')]",
                "storage": {
                  "storageSizeGB": "[parameters('storageSizeGB')]",
                  "autoGrow": "Enabled",
                  "autoIoScaling": "Enabled"
                },
                "backup": {
                  "backupRetentionDays": "[parameters('backupRetentionDays')]",
                  "geoRedundantBackup": "[parameters('geoRedundantBackup')]"
                },
                "highAvailability": {
                  "mode": "[parameters('highAvailabilityMode')]"
                },
                "network": {
                  "publicNetworkAccess": "Enabled"
                },
                "createMode": "Default"
              }
            },
            {
              "type": "Microsoft.DBforMySQL/flexibleServers/configurations",
              "apiVersion": "2024-12-30",
              "name": "[format('{0}/{1}', variables('mysqlServerName'), 'require_secure_transport')]",
              "properties": {
                "value": "ON",
                "source": "user-override"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforMySQL/flexibleServers', variables('mysqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('privateEndpointName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.DBforMySQL/flexibleServers', variables('mysqlServerName'))]",
                      "groupIds": [
                        "mysqlServer"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforMySQL/flexibleServers', variables('mysqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-mysql-database-azure-com",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2024-11-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'DB-USER')]",
              "properties": {
                "value": "[parameters('administratorLogin')]",
                "contentType": "text/plain"
              }
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2024-11-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'DB-PASSWORD')]",
              "properties": {
                "value": "[parameters('administratorLoginPassword')]",
                "contentType": "text/plain"
              }
            }
          ],
          "outputs": {
            "mysqlServerId": {
              "type": "string",
              "metadata": {
                "description": "MySQL server resource ID"
              },
              "value": "[resourceId('Microsoft.DBforMySQL/flexibleServers', variables('mysqlServerName'))]"
            },
            "mysqlServerName": {
              "type": "string",
              "metadata": {
                "description": "MySQL server name"
              },
              "value": "[variables('mysqlServerName')]"
            },
            "mysqlServerFqdn": {
              "type": "string",
              "metadata": {
                "description": "MySQL server FQDN"
              },
              "value": "[reference(resourceId('Microsoft.DBforMySQL/flexibleServers', variables('mysqlServerName')), '2024-12-30').fullyQualifiedDomainName]"
            },
            "privateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-redis",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "privateDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.redisDnsZoneId.value]"
          },
          "skuName": {
            "value": "[parameters('redisSkuName')]"
          },
          "highAvailability": {
            "value": "[parameters('redisHighAvailability')]"
          },
          "zones": {
            "value": "[parameters('redisZones')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16801194097542289632"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID"
              }
            },
            "privateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Redis private DNS zone resource ID"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Balanced_B5",
              "allowedValues": [
                "Balanced_B0",
                "Balanced_B1",
                "Balanced_B3",
                "Balanced_B5",
                "Balanced_B10",
                "Balanced_B20",
                "Balanced_B50",
                "Balanced_B100"
              ],
              "metadata": {
                "description": "Redis SKU name. Balanced tier recommended for standard workloads. Size suffix indicates approximate memory (B1=1GB, B5=5GB, B10=10GB, B20=20GB)."
              }
            },
            "highAvailability": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ],
              "metadata": {
                "description": "Enable high availability (data replication)"
              }
            },
            "zones": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Availability zones for zone redundancy"
              }
            },
            "evictionPolicy": {
              "type": "string",
              "defaultValue": "VolatileLRU",
              "allowedValues": [
                "NoEviction",
                "AllKeysLRU",
                "AllKeysLFU",
                "AllKeysRandom",
                "VolatileLRU",
                "VolatileLFU",
                "VolatileRandom",
                "VolatileTTL"
              ],
              "metadata": {
                "description": "Redis database eviction policy"
              }
            },
            "clusteringPolicy": {
              "type": "string",
              "defaultValue": "EnterpriseCluster"
            }
          },
          "variables": {
            "redisName": "[format('{0}-redis', parameters('namingPrefix'))]",
            "privateEndpointName": "[format('{0}-redis-pe', parameters('namingPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Cache/redisEnterprise",
              "apiVersion": "2025-07-01",
              "name": "[variables('redisName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('skuName')]"
              },
              "zones": "[if(not(empty(parameters('zones'))), parameters('zones'), null())]",
              "properties": {
                "minimumTlsVersion": "1.2",
                "publicNetworkAccess": "Disabled",
                "highAvailability": "[parameters('highAvailability')]"
              }
            },
            {
              "type": "Microsoft.Cache/redisEnterprise/databases",
              "apiVersion": "2025-07-01",
              "name": "[format('{0}/{1}', variables('redisName'), 'default')]",
              "properties": {
                "clientProtocol": "Encrypted",
                "accessKeysAuthentication": "Disabled",
                "port": 10000,
                "clusteringPolicy": "[parameters('clusteringPolicy')]",
                "evictionPolicy": "[parameters('evictionPolicy')]",
                "persistence": {
                  "aofEnabled": false,
                  "rdbEnabled": false
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redisEnterprise', variables('redisName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2024-05-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('privateEndpointName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Cache/redisEnterprise', variables('redisName'))]",
                      "groupIds": [
                        "redisEnterprise"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redisEnterprise', variables('redisName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-redis-azure-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "redisId": {
              "type": "string",
              "metadata": {
                "description": "Redis Enterprise cluster resource ID"
              },
              "value": "[resourceId('Microsoft.Cache/redisEnterprise', variables('redisName'))]"
            },
            "redisName": {
              "type": "string",
              "metadata": {
                "description": "Redis Enterprise cluster name"
              },
              "value": "[variables('redisName')]"
            },
            "redisHostName": {
              "type": "string",
              "metadata": {
                "description": "Redis host name (use with port 10000)"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redisEnterprise', variables('redisName')), '2025-07-01').hostName]"
            },
            "redisDatabaseId": {
              "type": "string",
              "metadata": {
                "description": "Redis database resource ID"
              },
              "value": "[resourceId('Microsoft.Cache/redisEnterprise/databases', variables('redisName'), 'default')]"
            },
            "privateEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-aks",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "aksNodesSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.aksNodesSubnetId.value]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.identityId.value]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.principalId.value]"
          },
          "aksDnsZoneId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones'), '2025-04-01').outputs.aksDnsZoneId.value]"
          },
          "acrId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-acr'), '2025-04-01').outputs.acrId.value]"
          },
          "kubernetesVersion": {
            "value": "[parameters('kubernetesVersion')]"
          },
          "enablePrivateCluster": {
            "value": "[parameters('aksEnablePrivateCluster')]"
          },
          "authorizedIPRanges": {
            "value": "[parameters('aksAuthorizedIPRanges')]"
          },
          "systemNodeVmSize": {
            "value": "[parameters('aksSystemNodeVmSize')]"
          },
          "systemNodeCount": {
            "value": "[parameters('aksSystemNodeCount')]"
          },
          "systemNodeMinCount": {
            "value": "[parameters('aksSystemNodeMinCount')]"
          },
          "systemNodeMaxCount": {
            "value": "[parameters('aksSystemNodeMaxCount')]"
          },
          "podCidr": {
            "value": "[parameters('aksPodCidr')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "464682278992025381"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "aksNodesSubnetId": {
              "type": "string",
              "metadata": {
                "description": "AKS nodes subnet resource ID"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource ID for AKS control plane"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity principal ID (for role assignments)"
              }
            },
            "aksDnsZoneId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "AKS private DNS zone resource ID (required for private cluster mode)"
              }
            },
            "acrId": {
              "type": "string",
              "metadata": {
                "description": "Container Registry resource ID for AcrPull role assignment"
              }
            },
            "kubernetesVersion": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Kubernetes version (leave empty for latest stable)"
              }
            },
            "enablePrivateCluster": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable private cluster mode (API server not publicly accessible)"
              }
            },
            "authorizedIPRanges": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Authorized IP ranges for API server access (ignored if privateCluster is true)"
              }
            },
            "disablePublicFqdn": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Disable public FQDN for private cluster"
              }
            },
            "systemNodeVmSize": {
              "type": "string",
              "defaultValue": "Standard_D4s_v5",
              "metadata": {
                "description": "System node pool VM size"
              }
            },
            "systemNodeCount": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 100,
              "metadata": {
                "description": "System node pool node count"
              }
            },
            "systemNodeMinCount": {
              "type": "int",
              "defaultValue": 2,
              "minValue": 1,
              "metadata": {
                "description": "System node pool min count for autoscaling"
              }
            },
            "systemNodeMaxCount": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "metadata": {
                "description": "System node pool max count for autoscaling"
              }
            },
            "enableAutoScaling": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable cluster autoscaler for system node pool"
              }
            },
            "availabilityZones": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "System node pool availability zones. Empty array = no zone pinning (works in all regions)."
              }
            },
            "podCidr": {
              "type": "string",
              "defaultValue": "192.168.0.0/16",
              "metadata": {
                "description": "Pod CIDR for Azure CNI Overlay. WARNING: Verify no overlap with on-prem networks."
              }
            },
            "serviceCidr": {
              "type": "string",
              "defaultValue": "10.100.0.0/16",
              "metadata": {
                "description": "Service CIDR for Kubernetes services"
              }
            },
            "dnsServiceIP": {
              "type": "string",
              "defaultValue": "10.100.0.10",
              "metadata": {
                "description": "DNS service IP (must be within serviceCidr)"
              }
            }
          },
          "variables": {
            "aksClusterName": "[format('{0}-aks', parameters('namingPrefix'))]",
            "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
            "aksClusterAdminRoleId": "0ab0b1a8-8aac-4efd-b8c2-3ee1fb270be8"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerService/managedClusters",
              "apiVersion": "2025-09-01",
              "name": "[variables('aksClusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "kubernetesVersion": "[if(not(empty(parameters('kubernetesVersion'))), parameters('kubernetesVersion'), null())]",
                "dnsPrefix": "[variables('aksClusterName')]",
                "oidcIssuerProfile": {
                  "enabled": true
                },
                "securityProfile": {
                  "workloadIdentity": {
                    "enabled": true
                  }
                },
                "apiServerAccessProfile": {
                  "enablePrivateCluster": "[parameters('enablePrivateCluster')]",
                  "privateDNSZone": "[if(parameters('enablePrivateCluster'), parameters('aksDnsZoneId'), null())]",
                  "authorizedIPRanges": "[if(and(not(parameters('enablePrivateCluster')), not(empty(parameters('authorizedIPRanges')))), parameters('authorizedIPRanges'), null())]",
                  "enablePrivateClusterPublicFQDN": "[if(parameters('enablePrivateCluster'), not(parameters('disablePublicFqdn')), null())]"
                },
                "networkProfile": {
                  "networkPlugin": "azure",
                  "networkPluginMode": "overlay",
                  "networkDataplane": "cilium",
                  "networkPolicy": "cilium",
                  "podCidr": "[parameters('podCidr')]",
                  "serviceCidr": "[parameters('serviceCidr')]",
                  "dnsServiceIP": "[parameters('dnsServiceIP')]",
                  "loadBalancerSku": "standard"
                },
                "addonProfiles": {
                  "azureKeyvaultSecretsProvider": {
                    "enabled": true,
                    "config": {
                      "enableSecretRotation": "true",
                      "rotationPollInterval": "2m"
                    }
                  }
                },
                "agentPoolProfiles": [
                  {
                    "name": "system",
                    "mode": "System",
                    "vmSize": "[parameters('systemNodeVmSize')]",
                    "count": "[parameters('systemNodeCount')]",
                    "minCount": "[if(parameters('enableAutoScaling'), parameters('systemNodeMinCount'), null())]",
                    "maxCount": "[if(parameters('enableAutoScaling'), parameters('systemNodeMaxCount'), null())]",
                    "enableAutoScaling": "[parameters('enableAutoScaling')]",
                    "availabilityZones": "[if(not(empty(parameters('availabilityZones'))), parameters('availabilityZones'), null())]",
                    "vnetSubnetID": "[parameters('aksNodesSubnetId')]",
                    "osSKU": "AzureLinux",
                    "osType": "Linux",
                    "nodeTaints": [
                      "CriticalAddonsOnly=true:NoSchedule"
                    ],
                    "nodeLabels": {
                      "nodepool-type": "system"
                    },
                    "upgradeSettings": {
                      "maxSurge": "33%"
                    }
                  }
                ],
                "autoUpgradeProfile": {
                  "upgradeChannel": "stable",
                  "nodeOSUpgradeChannel": "NodeImage"
                }
              }
            },
            {
              "type": "Microsoft.ContainerService/managedClusters/agentPools",
              "apiVersion": "2025-09-01",
              "name": "[format('{0}/{1}', variables('aksClusterName'), 'user')]",
              "properties": {
                "mode": "User",
                "vmSize": "[parameters('systemNodeVmSize')]",
                "count": "[parameters('systemNodeCount')]",
                "minCount": "[if(parameters('enableAutoScaling'), parameters('systemNodeMinCount'), null())]",
                "maxCount": "[if(parameters('enableAutoScaling'), parameters('systemNodeMaxCount'), null())]",
                "enableAutoScaling": "[parameters('enableAutoScaling')]",
                "availabilityZones": "[if(not(empty(parameters('availabilityZones'))), parameters('availabilityZones'), null())]",
                "vnetSubnetID": "[parameters('aksNodesSubnetId')]",
                "osSKU": "AzureLinux",
                "osType": "Linux",
                "nodeLabels": {
                  "nodepool-type": "user"
                },
                "upgradeSettings": {
                  "maxSurge": "33%"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), parameters('acrId'), variables('acrPullRoleId'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), '2025-09-01').identityProfile.kubeletidentity.objectId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('acrPullRoleId'))]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', variables('aksClusterName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), parameters('managedIdentityPrincipalId'), variables('aksClusterAdminRoleId'))]",
              "properties": {
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('aksClusterAdminRoleId'))]",
                "principalType": "ServicePrincipal",
                "description": "Allow managed identity to run az aks command invoke for deploymentScript"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName'))]"
              ]
            }
          ],
          "outputs": {
            "aksClusterId": {
              "type": "string",
              "metadata": {
                "description": "AKS cluster resource ID"
              },
              "value": "[resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName'))]"
            },
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "AKS cluster name"
              },
              "value": "[variables('aksClusterName')]"
            },
            "aksClusterFqdn": {
              "type": "string",
              "metadata": {
                "description": "AKS cluster FQDN (for public clusters) or private FQDN"
              },
              "value": "[if(parameters('enablePrivateCluster'), reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), '2025-09-01').privateFQDN, reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), '2025-09-01').fqdn)]"
            },
            "oidcIssuerUrl": {
              "type": "string",
              "metadata": {
                "description": "AKS OIDC Issuer URL (for federated credentials)"
              },
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), '2025-09-01').oidcIssuerProfile.issuerURL]"
            },
            "kubeletIdentityObjectId": {
              "type": "string",
              "metadata": {
                "description": "AKS kubelet identity object ID"
              },
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), '2025-09-01').identityProfile.kubeletidentity.objectId]"
            },
            "kubeletIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "AKS kubelet identity client ID"
              },
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), '2025-09-01').identityProfile.kubeletidentity.clientId]"
            },
            "nodeResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Managed cluster resource group (MC_ resource group)"
              },
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksClusterName')), '2025-09-01').nodeResourceGroup]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-acr')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-dns-zones')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "condition": "[parameters('deployGpuNodePool')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-aks-gpu-nodepool",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aksClusterName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.aksClusterName.value]"
          },
          "gpuVmSize": {
            "value": "[parameters('gpuNodeVmSize')]"
          },
          "aksNodesSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.aksNodesSubnetId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6240568939471257387"
            }
          },
          "parameters": {
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "Existing AKS cluster name"
              }
            },
            "nodePoolName": {
              "type": "string",
              "defaultValue": "gpu",
              "metadata": {
                "description": "GPU node pool name"
              }
            },
            "gpuVmSize": {
              "type": "string",
              "defaultValue": "Standard_NC4as_T4_v3",
              "allowedValues": [
                "Standard_NC4as_T4_v3",
                "Standard_NC8as_T4_v3",
                "Standard_NC16as_T4_v3",
                "Standard_NC64as_T4_v3"
              ],
              "metadata": {
                "description": "GPU VM size (T4 series recommended)"
              }
            },
            "nodeCount": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 10,
              "metadata": {
                "description": "Initial node count"
              }
            },
            "minCount": {
              "type": "int",
              "defaultValue": 0,
              "minValue": 0,
              "metadata": {
                "description": "Minimum node count for autoscaling (0 = scale to zero)"
              }
            },
            "maxCount": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "metadata": {
                "description": "Maximum node count for autoscaling"
              }
            },
            "enableAutoScaling": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable cluster autoscaler"
              }
            },
            "aksNodesSubnetId": {
              "type": "string",
              "metadata": {
                "description": "AKS nodes subnet resource ID"
              }
            },
            "availabilityZones": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Availability zones (GPU SKUs may have limited zone availability)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerService/managedClusters/agentPools",
              "apiVersion": "2025-09-01",
              "name": "[format('{0}/{1}', parameters('aksClusterName'), parameters('nodePoolName'))]",
              "properties": {
                "mode": "User",
                "vmSize": "[parameters('gpuVmSize')]",
                "count": "[parameters('nodeCount')]",
                "minCount": "[if(parameters('enableAutoScaling'), parameters('minCount'), null())]",
                "maxCount": "[if(parameters('enableAutoScaling'), parameters('maxCount'), null())]",
                "enableAutoScaling": "[parameters('enableAutoScaling')]",
                "availabilityZones": "[if(not(empty(parameters('availabilityZones'))), parameters('availabilityZones'), null())]",
                "vnetSubnetID": "[parameters('aksNodesSubnetId')]",
                "osSKU": "AzureLinux",
                "osType": "Linux",
                "nodeLabels": {
                  "nodepool-type": "gpu",
                  "gpu": "nvidia-t4",
                  "hardware-type": "gpu"
                },
                "nodeTaints": [
                  "nvidia.com/gpu=present:NoSchedule"
                ],
                "scaleDownMode": "[if(parameters('enableAutoScaling'), 'Delete', null())]",
                "upgradeSettings": {
                  "maxSurge": "33%"
                }
              }
            }
          ],
          "outputs": {
            "nodePoolName": {
              "type": "string",
              "metadata": {
                "description": "GPU node pool name"
              },
              "value": "[parameters('nodePoolName')]"
            },
            "provisioningState": {
              "type": "string",
              "metadata": {
                "description": "GPU node pool provisioning state"
              },
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters/agentPools', parameters('aksClusterName'), parameters('nodePoolName')), '2025-09-01').provisioningState]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-monitoring",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "aksClusterName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.aksClusterName.value]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.keyVaultName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3603960559198349803"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "AKS cluster name for DCR association"
              }
            },
            "workspaceSku": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "Free",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
              ],
              "metadata": {
                "description": "Log Analytics workspace SKU"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Log Analytics data retention in days"
              }
            },
            "enableContainerLogV2": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable ContainerLogV2 schema (recommended)"
              }
            },
            "collectionInterval": {
              "type": "string",
              "defaultValue": "5m",
              "allowedValues": [
                "1m",
                "5m",
                "10m",
                "15m",
                "30m"
              ],
              "metadata": {
                "description": "Container Insights data collection interval"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for storing secrets (if provided, App Insights connection string is stored)"
              }
            }
          },
          "variables": {
            "workspaceName": "[format('{0}-law', parameters('namingPrefix'))]",
            "appInsightsName": "[format('{0}-appi', parameters('namingPrefix'))]",
            "dceName": "[format('{0}-dce', parameters('namingPrefix'))]",
            "dcrName": "[format('MSCI-{0}-{1}', parameters('location'), parameters('aksClusterName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('workspaceSku')]"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "RetentionInDays": "[parameters('retentionInDays')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/dataCollectionEndpoints",
              "apiVersion": "2023-03-11",
              "name": "[variables('dceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "Linux",
              "properties": {
                "description": "Data collection endpoint for Container Insights",
                "networkAcls": {
                  "publicNetworkAccess": "Enabled"
                }
              }
            },
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2023-03-11",
              "name": "[variables('dcrName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "Linux",
              "properties": {
                "description": "Data collection rule for Container Insights",
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "dataSources": {
                  "extensions": [
                    {
                      "name": "ContainerInsightsExtension",
                      "extensionName": "ContainerInsights",
                      "streams": "[if(parameters('enableContainerLogV2'), createArray('Microsoft-ContainerLogV2', 'Microsoft-KubeEvents', 'Microsoft-KubePodInventory', 'Microsoft-KubeNodeInventory', 'Microsoft-KubeServices', 'Microsoft-KubeMonAgentEvents', 'Microsoft-InsightsMetrics', 'Microsoft-Perf'), createArray('Microsoft-ContainerLog', 'Microsoft-KubeEvents', 'Microsoft-KubePodInventory', 'Microsoft-KubeNodeInventory', 'Microsoft-KubeServices', 'Microsoft-KubeMonAgentEvents', 'Microsoft-InsightsMetrics', 'Microsoft-Perf'))]",
                      "extensionSettings": {
                        "dataCollectionSettings": {
                          "interval": "[parameters('collectionInterval')]",
                          "namespaceFilteringMode": "Off",
                          "enableContainerLogV2": "[parameters('enableContainerLogV2')]"
                        }
                      }
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
                      "name": "ciworkspace"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": "[if(parameters('enableContainerLogV2'), createArray('Microsoft-ContainerLogV2', 'Microsoft-KubeEvents', 'Microsoft-KubePodInventory', 'Microsoft-KubeNodeInventory', 'Microsoft-KubeServices', 'Microsoft-KubeMonAgentEvents', 'Microsoft-InsightsMetrics', 'Microsoft-Perf'), createArray('Microsoft-ContainerLog', 'Microsoft-KubeEvents', 'Microsoft-KubePodInventory', 'Microsoft-KubeNodeInventory', 'Microsoft-KubeServices', 'Microsoft-KubeMonAgentEvents', 'Microsoft-InsightsMetrics', 'Microsoft-Perf'))]",
                    "destinations": [
                      "ciworkspace"
                    ]
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2023-03-11",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', parameters('aksClusterName'))]",
              "name": "ContainerInsightsExtension",
              "properties": {
                "dataCollectionRuleId": "[resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))]",
                "description": "Association of data collection rule for Container Insights"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', parameters('aksClusterName'))]",
              "name": "aks-audit-logs",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
                "logs": [
                  {
                    "category": "kube-audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "kube-audit-admin",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "kube-controller-manager",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "kube-scheduler",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "cluster-autoscaler",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "guard",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2024-11-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'APPLICATIONINSIGHTS-CONNECTION-STRING')]",
              "properties": {
                "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]",
                "contentType": "text/plain"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
              ]
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace name"
              },
              "value": "[variables('workspaceName')]"
            },
            "workspaceCustomerId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace customer ID (for agent configuration)"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2023-09-01').customerId]"
            },
            "dceId": {
              "type": "string",
              "metadata": {
                "description": "Data collection endpoint resource ID"
              },
              "value": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]"
            },
            "dcrId": {
              "type": "string",
              "metadata": {
                "description": "Data collection rule resource ID"
              },
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))]"
            },
            "appInsightsId": {
              "type": "string",
              "metadata": {
                "description": "Application Insights resource ID"
              },
              "value": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              },
              "value": "[variables('appInsightsName')]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-federated-credentials",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.identityName.value]"
          },
          "aksOidcIssuerUrl": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.oidcIssuerUrl.value]"
          },
          "namespace": {
            "value": "[parameters('workloadNamespace')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3658205762341126476"
            }
          },
          "parameters": {
            "managedIdentityName": {
              "type": "string",
              "metadata": {
                "description": "Existing managed identity name to add federated credentials to"
              }
            },
            "aksOidcIssuerUrl": {
              "type": "string",
              "metadata": {
                "description": "AKS OIDC issuer URL (from aks.properties.oidcIssuerProfile.issuerUrl)"
              }
            },
            "namespace": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "Kubernetes namespace where ServiceAccount is created"
              }
            }
          },
          "variables": {
            "audiences": [
              "api://AzureADTokenExchange"
            ]
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
              "apiVersion": "2024-11-30",
              "name": "[format('{0}/{1}', parameters('managedIdentityName'), 'fc-sa-qwiser')]",
              "properties": {
                "issuer": "[parameters('aksOidcIssuerUrl')]",
                "subject": "[format('system:serviceaccount:{0}:sa-qwiser', parameters('namespace'))]",
                "audiences": "[variables('audiences')]"
              }
            }
          ],
          "outputs": {
            "federatedCredentialName": {
              "type": "string",
              "metadata": {
                "description": "Created federated credential name"
              },
              "value": "fc-sa-qwiser"
            },
            "managedIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity client ID (needed for K8s ServiceAccount annotation)"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2024-11-30').clientId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-mc-rg-reader-role",
      "resourceGroup": "[variables('nodeResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12648764184859909686"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity to grant access"
              }
            }
          },
          "variables": {
            "readerRoleId": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('principalId'), variables('readerRoleId'))]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('readerRoleId'))]",
                "principalType": "ServicePrincipal",
                "description": "Allow managed identity to query ILB resources for PLS creation"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-nginx-ingress",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "aksClusterName": {
            "value": "[variables('aksClusterName')]"
          },
          "aksResourceGroupName": {
            "value": "[variables('resourceGroupName')]"
          },
          "nodeResourceGroupName": {
            "value": "[variables('nodeResourceGroupName')]"
          },
          "nginxIngressPrivateIpAddress": {
            "value": "[parameters('nginxIngressPrivateIp')]"
          },
          "managedIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.identityId.value]"
          },
          "appConfigEndpoint": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-appconfig'), '2025-04-01').outputs.appConfigEndpoint.value]"
          },
          "configLabel": "[if(equals(parameters('environmentName'), 'staging'), createObject('value', 'staging'), createObject('value', 'production'))]",
          "baseUrl": {
            "value": "[format('https://{0}', parameters('customDomain'))]"
          },
          "acrLoginServer": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-acr'), '2025-04-01').outputs.acrLoginServer.value]"
          },
          "workloadNamespace": {
            "value": "[parameters('workloadNamespace')]"
          },
          "uamiClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.clientId.value]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "tenantId": {
            "value": "[tenant().tenantId]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "18423843520262346832"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "AKS cluster name"
              }
            },
            "aksResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "AKS cluster resource group name"
              }
            },
            "nodeResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "AKS node resource group name (MC_ resource group)"
              }
            },
            "nginxIngressPrivateIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Static IP for NGINX Ingress internal load balancer (must be in AKS subnet range)"
              }
            },
            "nginxIngressVersion": {
              "type": "string",
              "defaultValue": "4.12.0",
              "metadata": {
                "description": "Helm chart version for NGINX Ingress Controller"
              }
            },
            "nginxIngressNamespace": {
              "type": "string",
              "defaultValue": "ingress-nginx",
              "metadata": {
                "description": "Kubernetes namespace for NGINX Ingress Controller"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource ID"
              }
            },
            "appConfigEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure App Configuration endpoint URL"
              }
            },
            "configLabel": {
              "type": "string",
              "defaultValue": "production",
              "allowedValues": [
                "production",
                "staging"
              ],
              "metadata": {
                "description": "Config label for Azure App Configuration (production or staging)"
              }
            },
            "baseUrl": {
              "type": "string",
              "metadata": {
                "description": "Base URL for QWiser services (e.g., https://qwiser.university.edu)"
              }
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "ACR login server (e.g., myunivacr.azurecr.io)"
              }
            },
            "workloadNamespace": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "Kubernetes namespace for QWiser workloads"
              }
            },
            "uamiClientId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity client ID (for Workload Identity)"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Azure Key Vault name"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD tenant ID"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name for ML models"
              }
            }
          },
          "variables": {
            "deploymentScriptName": "[format('{0}-nginx-install', parameters('namingPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[variables('deploymentScriptName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.67.0",
                "timeout": "PT30M",
                "retentionInterval": "P1D",
                "cleanupPreference": "OnSuccess",
                "environmentVariables": [
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "AKS_RESOURCE_GROUP",
                    "value": "[parameters('aksResourceGroupName')]"
                  },
                  {
                    "name": "NODE_RESOURCE_GROUP",
                    "value": "[parameters('nodeResourceGroupName')]"
                  },
                  {
                    "name": "NGINX_INGRESS_VERSION",
                    "value": "[parameters('nginxIngressVersion')]"
                  },
                  {
                    "name": "NGINX_INGRESS_NAMESPACE",
                    "value": "[parameters('nginxIngressNamespace')]"
                  },
                  {
                    "name": "NGINX_PRIVATE_IP",
                    "value": "[parameters('nginxIngressPrivateIpAddress')]"
                  },
                  {
                    "name": "QWISER_NAMESPACE",
                    "value": "[parameters('workloadNamespace')]"
                  },
                  {
                    "name": "APP_CONFIG_ENDPOINT",
                    "value": "[parameters('appConfigEndpoint')]"
                  },
                  {
                    "name": "CONFIG_LABEL",
                    "value": "[parameters('configLabel')]"
                  },
                  {
                    "name": "BASE_URL",
                    "value": "[parameters('baseUrl')]"
                  },
                  {
                    "name": "ACR_LOGIN_SERVER",
                    "value": "[parameters('acrLoginServer')]"
                  },
                  {
                    "name": "UAMI_CLIENT_ID",
                    "value": "[parameters('uamiClientId')]"
                  },
                  {
                    "name": "KEY_VAULT_NAME",
                    "value": "[parameters('keyVaultName')]"
                  },
                  {
                    "name": "TENANT_ID",
                    "value": "[parameters('tenantId')]"
                  },
                  {
                    "name": "STORAGE_ACCOUNT_NAME",
                    "value": "[parameters('storageAccountName')]"
                  }
                ],
                "scriptContent": "      #!/bin/bash\r\n      set -e\r\n\r\n      echo \"Installing NGINX Ingress Controller on AKS cluster...\"\r\n      echo \"Cluster: $AKS_CLUSTER_NAME in $AKS_RESOURCE_GROUP\"\r\n\r\n      # Create the Helm install command with values for internal LoadBalancer\r\n      HELM_COMMAND=\"helm upgrade --install nginx-ingress ingress-nginx/ingress-nginx \\\r\n        --namespace $NGINX_INGRESS_NAMESPACE \\\r\n        --create-namespace \\\r\n        --version $NGINX_INGRESS_VERSION \\\r\n        --set controller.replicaCount=2 \\\r\n        --set controller.service.annotations.'service\\\\.beta\\\\.kubernetes\\\\.io/azure-load-balancer-internal'='true' \\\r\n        --set controller.service.annotations.'service\\\\.beta\\\\.kubernetes\\\\.io/azure-load-balancer-internal-subnet'='aks-nodes' \\\r\n        --set controller.service.annotations.'service\\\\.beta\\\\.kubernetes\\\\.io/azure-load-balancer-health-probe-request-path'='/healthz' \\\r\n        --set controller.service.loadBalancerIP=$NGINX_PRIVATE_IP \\\r\n        --set controller.service.externalTrafficPolicy=Local \\\r\n        --set controller.nodeSelector.'kubernetes\\\\.io/os'=linux \\\r\n        --set defaultBackend.nodeSelector.'kubernetes\\\\.io/os'=linux \\\r\n        --set controller.resources.requests.cpu=100m \\\r\n        --set controller.resources.requests.memory=256Mi \\\r\n        --set controller.resources.limits.cpu=1000m \\\r\n        --set controller.resources.limits.memory=1Gi \\\r\n        --set controller.containerSecurityContext.runAsNonRoot=true \\\r\n        --set controller.containerSecurityContext.allowPrivilegeEscalation=false \\\r\n        --wait \\\r\n        --timeout 10m\"\r\n\r\n      # Execute via az aks command invoke (works for both public and private clusters)\r\n      echo \"Running: az aks command invoke...\"\r\n      az aks command invoke \\\r\n        --resource-group \"$AKS_RESOURCE_GROUP\" \\\r\n        --name \"$AKS_CLUSTER_NAME\" \\\r\n        --command \"helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx && helm repo update && $HELM_COMMAND\"\r\n\r\n      echo \"NGINX Ingress Controller installed. Waiting for LoadBalancer...\"\r\n\r\n      # Wait for LoadBalancer to be created and get external IP\r\n      for i in {1..30}; do\r\n        echo \"Checking for LoadBalancer IP (attempt $i/30)...\"\r\n\r\n        LB_IP=$(az aks command invoke \\\r\n          --resource-group \"$AKS_RESOURCE_GROUP\" \\\r\n          --name \"$AKS_CLUSTER_NAME\" \\\r\n          --command \"kubectl get svc nginx-ingress-ingress-nginx-controller -n $NGINX_INGRESS_NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}'\" \\\r\n          --query \"logs\" -o tsv 2>/dev/null | tr -d '\\n')\r\n\r\n        if [ -n \"$LB_IP\" ] && [ \"$LB_IP\" != \"null\" ]; then\r\n          echo \"LoadBalancer IP assigned: $LB_IP\"\r\n          break\r\n        fi\r\n\r\n        sleep 10\r\n      done\r\n\r\n      if [ -z \"$LB_IP\" ] || [ \"$LB_IP\" == \"null\" ]; then\r\n        echo \"ERROR: LoadBalancer IP not assigned after 5 minutes\"\r\n        exit 1\r\n      fi\r\n\r\n      # Get the internal LoadBalancer resource ID from the node resource group\r\n      echo \"Querying for internal LoadBalancer in $NODE_RESOURCE_GROUP...\"\r\n\r\n      ILB_ID=$(az network lb show \\\r\n        --resource-group \"$NODE_RESOURCE_GROUP\" \\\r\n        --name \"kubernetes-internal\" \\\r\n        --query \"id\" -o tsv 2>/dev/null || echo \"\")\r\n\r\n      if [ -z \"$ILB_ID\" ]; then\r\n        echo \"ERROR: kubernetes-internal LoadBalancer not found\"\r\n        exit 1\r\n      fi\r\n\r\n      echo \"ILB Resource ID: $ILB_ID\"\r\n\r\n      # Get frontend IP configuration ID\r\n      FRONTEND_IP_CONFIG_ID=$(az network lb frontend-ip list \\\r\n        --resource-group \"$NODE_RESOURCE_GROUP\" \\\r\n        --lb-name \"kubernetes-internal\" \\\r\n        --query \"[?privateIPAddress=='$NGINX_PRIVATE_IP'].id | [0]\" -o tsv 2>/dev/null || echo \"\")\r\n\r\n      if [ -z \"$FRONTEND_IP_CONFIG_ID\" ]; then\r\n        # Try getting any frontend IP config if specific IP not found\r\n        FRONTEND_IP_CONFIG_ID=$(az network lb frontend-ip list \\\r\n          --resource-group \"$NODE_RESOURCE_GROUP\" \\\r\n          --lb-name \"kubernetes-internal\" \\\r\n          --query \"[0].id\" -o tsv 2>/dev/null || echo \"\")\r\n      fi\r\n\r\n      if [ -z \"$FRONTEND_IP_CONFIG_ID\" ]; then\r\n        echo \"ERROR: Frontend IP configuration not found\"\r\n        exit 1\r\n      fi\r\n\r\n      echo \"Frontend IP Configuration ID: $FRONTEND_IP_CONFIG_ID\"\r\n\r\n      # ============================================================\r\n      # Create QWiser ConfigMap with URL environment variables\r\n      # ============================================================\r\n      echo \"Creating QWiser ConfigMap in namespace $QWISER_NAMESPACE...\"\r\n\r\n      # Extract domain from BASE_URL (remove https:// prefix)\r\n      # e.g., https://qwiser.university.edu -> qwiser.university.edu\r\n      CUSTOM_DOMAIN=$(echo \"$BASE_URL\" | sed 's|^https://||' | sed 's|^http://||' | sed 's|/$||')\r\n      echo \"Extracted custom domain: $CUSTOM_DOMAIN\"\r\n\r\n      CONFIGMAP_YAML=\"apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: qwiser-config\r\n  namespace: $QWISER_NAMESPACE\r\ndata:\r\n  AZURE_APP_CONFIG_ENDPOINT: \\\"$APP_CONFIG_ENDPOINT\\\"\r\n  CONFIG_LABEL: \\\"$CONFIG_LABEL\\\"\r\n  PUBLIC_URL: \\\"$BASE_URL\\\"\r\n  FRONTEND_URL: \\\"$BASE_URL\\\"\r\n  REACT_APP_SERVER_API_URL: \\\"$BASE_URL\\\"\r\n  CUSTOM_DOMAIN: \\\"$CUSTOM_DOMAIN\\\"\r\n  ACR_LOGIN_SERVER: \\\"$ACR_LOGIN_SERVER\\\"\r\n  UAMI_CLIENT_ID: \\\"$UAMI_CLIENT_ID\\\"\r\n  KEY_VAULT_NAME: \\\"$KEY_VAULT_NAME\\\"\r\n  TENANT_ID: \\\"$TENANT_ID\\\"\r\n  STORAGE_ACCOUNT_NAME: \\\"$STORAGE_ACCOUNT_NAME\\\"\"\r\n\r\n      # Create namespace if it doesn't exist, then apply ConfigMap\r\n      az aks command invoke \\\r\n        --resource-group \"$AKS_RESOURCE_GROUP\" \\\r\n        --name \"$AKS_CLUSTER_NAME\" \\\r\n        --command \"kubectl create namespace $QWISER_NAMESPACE --dry-run=client -o yaml | kubectl apply -f - && echo '$CONFIGMAP_YAML' | kubectl apply -f -\"\r\n\r\n      echo \"QWiser ConfigMap created successfully.\"\r\n\r\n      # Output values for use by other Bicep resources\r\n      echo \"{ \\\"ilbId\\\": \\\"$ILB_ID\\\", \\\"frontendIpConfigId\\\": \\\"$FRONTEND_IP_CONFIG_ID\\\", \\\"loadBalancerIp\\\": \\\"$LB_IP\\\" }\" > $AZ_SCRIPTS_OUTPUT_PATH\r\n\r\n      echo \"NGINX Ingress installation complete!\"\r\n    "
              }
            }
          ],
          "outputs": {
            "scriptId": {
              "type": "string",
              "metadata": {
                "description": "Deployment script resource ID"
              },
              "value": "[resourceId('Microsoft.Resources/deploymentScripts', variables('deploymentScriptName'))]"
            },
            "ilbId": {
              "type": "string",
              "metadata": {
                "description": "Internal LoadBalancer resource ID"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', variables('deploymentScriptName')), '2023-08-01').outputs.ilbId]"
            },
            "frontendIpConfigId": {
              "type": "string",
              "metadata": {
                "description": "Frontend IP configuration resource ID for PLS"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', variables('deploymentScriptName')), '2023-08-01').outputs.frontendIpConfigId]"
            },
            "loadBalancerIp": {
              "type": "string",
              "metadata": {
                "description": "LoadBalancer IP address"
              },
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', variables('deploymentScriptName')), '2023-08-01').outputs.loadBalancerIp]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-acr')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-appconfig')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('nodeResourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mc-rg-reader-role')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-private-link-service",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "peSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
          },
          "frontendIpConfigId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-nginx-ingress'), '2025-04-01').outputs.frontendIpConfigId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14557173436653962918"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for resources"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "peSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Private endpoints subnet resource ID (for NAT IPs)"
              }
            },
            "frontendIpConfigId": {
              "type": "string",
              "metadata": {
                "description": "Frontend IP configuration resource ID from the internal LoadBalancer"
              }
            }
          },
          "variables": {
            "plsName": "[format('{0}-pls-nginx', parameters('namingPrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateLinkServices",
              "apiVersion": "2024-05-01",
              "name": "[variables('plsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "loadBalancerFrontendIpConfigurations": [
                  {
                    "id": "[parameters('frontendIpConfigId')]"
                  }
                ],
                "ipConfigurations": [
                  {
                    "name": "pls-nat-ip-1",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "privateIPAddressVersion": "IPv4",
                      "subnet": {
                        "id": "[parameters('peSubnetId')]"
                      },
                      "primary": true
                    }
                  },
                  {
                    "name": "pls-nat-ip-2",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "privateIPAddressVersion": "IPv4",
                      "subnet": {
                        "id": "[parameters('peSubnetId')]"
                      },
                      "primary": false
                    }
                  }
                ],
                "visibility": {
                  "subscriptions": [
                    "[subscription().subscriptionId]"
                  ]
                },
                "autoApproval": {
                  "subscriptions": []
                },
                "enableProxyProtocol": false,
                "fqdns": []
              }
            }
          ],
          "outputs": {
            "plsId": {
              "type": "string",
              "metadata": {
                "description": "Private Link Service resource ID"
              },
              "value": "[resourceId('Microsoft.Network/privateLinkServices', variables('plsName'))]"
            },
            "plsName": {
              "type": "string",
              "metadata": {
                "description": "Private Link Service name"
              },
              "value": "[variables('plsName')]"
            },
            "plsAlias": {
              "type": "string",
              "metadata": {
                "description": "Private Link Service alias (for PE connection)"
              },
              "value": "[reference(resourceId('Microsoft.Network/privateLinkServices', variables('plsName')), '2024-05-01').alias]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-nginx-ingress')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-front-door",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namingPrefix": {
            "value": "[variables('namingPrefix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "privateLinkServiceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-link-service'), '2025-04-01').outputs.plsId.value]"
          },
          "privateLinkServiceLocation": {
            "value": "[variables('location')]"
          },
          "originPrivateIpAddress": {
            "value": "[parameters('nginxIngressPrivateIp')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring'), '2025-04-01').outputs.workspaceId.value]"
          },
          "enableWaf": {
            "value": "[parameters('enableWaf')]"
          },
          "wafMode": {
            "value": "[parameters('wafMode')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2267875425063217225"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "global",
              "metadata": {
                "description": "Azure region for resources (global for Front Door)"
              }
            },
            "namingPrefix": {
              "type": "string",
              "metadata": {
                "description": "Naming prefix for resources"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to apply to resources"
              }
            },
            "privateLinkServiceId": {
              "type": "string",
              "metadata": {
                "description": "Private Link Service resource ID"
              }
            },
            "privateLinkServiceLocation": {
              "type": "string",
              "metadata": {
                "description": "Private Link Service location (must match PLS location for PE creation)"
              }
            },
            "originPrivateIpAddress": {
              "type": "string",
              "metadata": {
                "description": "Private IP address of the internal load balancer"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID for diagnostics"
              }
            },
            "enableWaf": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Web Application Firewall"
              }
            },
            "wafMode": {
              "type": "string",
              "defaultValue": "Prevention",
              "allowedValues": [
                "Detection",
                "Prevention"
              ],
              "metadata": {
                "description": "WAF mode"
              }
            }
          },
          "variables": {
            "frontDoorName": "[format('{0}-fd', parameters('namingPrefix'))]",
            "endpointName": "[format('{0}-endpoint', parameters('namingPrefix'))]",
            "originGroupName": "default-origin-group",
            "originName": "aks-pls-origin",
            "routeName": "default-route",
            "wafPolicyName": "[format('{0}waf', replace(parameters('namingPrefix'), '-', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.Cdn/profiles",
              "apiVersion": "2024-02-01",
              "name": "[variables('frontDoorName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Premium_AzureFrontDoor"
              },
              "properties": {
                "originResponseTimeoutSeconds": 60
              }
            },
            {
              "type": "Microsoft.Cdn/profiles/afdEndpoints",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', variables('frontDoorName'), variables('endpointName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "enabledState": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/originGroups",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', variables('frontDoorName'), variables('originGroupName'))]",
              "properties": {
                "loadBalancingSettings": {
                  "sampleSize": 4,
                  "successfulSamplesRequired": 3,
                  "additionalLatencyInMilliseconds": 0
                },
                "healthProbeSettings": {
                  "probePath": "/healthz",
                  "probeRequestType": "GET",
                  "probeProtocol": "Http",
                  "probeIntervalInSeconds": 30
                },
                "sessionAffinityState": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/originGroups/origins",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('originGroupName'), variables('originName'))]",
              "properties": {
                "hostName": "[parameters('originPrivateIpAddress')]",
                "httpPort": 80,
                "httpsPort": 443,
                "originHostHeader": "[parameters('originPrivateIpAddress')]",
                "priority": 1,
                "weight": 1000,
                "enabledState": "Enabled",
                "enforceCertificateNameCheck": false,
                "sharedPrivateLinkResource": {
                  "privateLink": {
                    "id": "[parameters('privateLinkServiceId')]"
                  },
                  "privateLinkLocation": "[parameters('privateLinkServiceLocation')]",
                  "requestMessage": "Front Door origin connection to NGINX Ingress",
                  "groupId": ""
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupName'))]"
              ]
            },
            {
              "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('endpointName'), variables('routeName'))]",
              "properties": {
                "originGroup": {
                  "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupName'))]"
                },
                "supportedProtocols": [
                  "Http",
                  "Https"
                ],
                "patternsToMatch": [
                  "/*"
                ],
                "forwardingProtocol": "HttpOnly",
                "linkToDefaultDomain": "Enabled",
                "httpsRedirect": "Enabled",
                "enabledState": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
                "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', variables('frontDoorName'), variables('originGroupName'), variables('originName'))]",
                "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupName'))]"
              ]
            },
            {
              "condition": "[parameters('enableWaf')]",
              "type": "Microsoft.Network/FrontDoorWebApplicationFirewallPolicies",
              "apiVersion": "2024-02-01",
              "name": "[variables('wafPolicyName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Premium_AzureFrontDoor"
              },
              "properties": {
                "policySettings": {
                  "enabledState": "Enabled",
                  "mode": "[parameters('wafMode')]",
                  "requestBodyCheck": "Enabled"
                },
                "managedRules": {
                  "managedRuleSets": [
                    {
                      "ruleSetType": "Microsoft_DefaultRuleSet",
                      "ruleSetVersion": "2.1",
                      "ruleSetAction": "Block"
                    },
                    {
                      "ruleSetType": "Microsoft_BotManagerRuleSet",
                      "ruleSetVersion": "1.0",
                      "ruleSetAction": "Block"
                    }
                  ]
                },
                "customRules": {
                  "rules": [
                    {
                      "name": "RateLimitRule",
                      "priority": 100,
                      "enabledState": "Enabled",
                      "ruleType": "RateLimitRule",
                      "rateLimitDurationInMinutes": 1,
                      "rateLimitThreshold": 1000,
                      "matchConditions": [
                        {
                          "matchVariable": "RequestUri",
                          "operator": "Contains",
                          "negateCondition": false,
                          "matchValue": [
                            "/"
                          ]
                        }
                      ],
                      "action": "Block"
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('enableWaf')]",
              "type": "Microsoft.Cdn/profiles/securityPolicies",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', variables('frontDoorName'), 'waf-security-policy')]",
              "properties": {
                "parameters": {
                  "type": "WebApplicationFirewall",
                  "wafPolicy": {
                    "id": "[resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', variables('wafPolicyName'))]"
                  },
                  "associations": [
                    {
                      "domains": [
                        {
                          "id": "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]"
                        }
                      ],
                      "patternsToMatch": [
                        "/*"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
                "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]",
                "[resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', variables('wafPolicyName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Cdn/profiles/{0}', variables('frontDoorName'))]",
              "name": "front-door-diagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "FrontDoorAccessLog",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "FrontDoorHealthProbeLog",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "FrontDoorWebApplicationFirewallLog",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
              ]
            }
          ],
          "outputs": {
            "frontDoorId": {
              "type": "string",
              "metadata": {
                "description": "Front Door profile resource ID"
              },
              "value": "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
            },
            "frontDoorName": {
              "type": "string",
              "metadata": {
                "description": "Front Door profile name"
              },
              "value": "[variables('frontDoorName')]"
            },
            "frontDoorEndpointHostname": {
              "type": "string",
              "metadata": {
                "description": "Front Door endpoint hostname (use for CNAME)"
              },
              "value": "[reference(resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName')), '2024-02-01').hostName]"
            },
            "frontDoorEndpointId": {
              "type": "string",
              "metadata": {
                "description": "Front Door endpoint ID"
              },
              "value": "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]"
            },
            "wafPolicyId": {
              "type": "string",
              "metadata": {
                "description": "WAF policy resource ID"
              },
              "value": "[if(parameters('enableWaf'), resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', variables('wafPolicyName')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-link-service')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource group name"
      },
      "value": "[variables('resourceGroupName')]"
    },
    "vnetId": {
      "type": "string",
      "metadata": {
        "description": "VNet resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.vnetId.value]"
    },
    "aksNodesSubnetId": {
      "type": "string",
      "metadata": {
        "description": "AKS nodes subnet resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.aksNodesSubnetId.value]"
    },
    "peSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Private endpoints subnet resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-vnet'), '2025-04-01').outputs.peSubnetId.value]"
    },
    "managedIdentityId": {
      "type": "string",
      "metadata": {
        "description": "Managed identity resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.identityId.value]"
    },
    "managedIdentityPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "Managed identity principal ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.principalId.value]"
    },
    "managedIdentityClientId": {
      "type": "string",
      "metadata": {
        "description": "Managed identity client ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-managed-identity'), '2025-04-01').outputs.clientId.value]"
    },
    "keyVaultId": {
      "type": "string",
      "metadata": {
        "description": "Key Vault resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.keyVaultId.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-keyvault'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "appConfigId": {
      "type": "string",
      "metadata": {
        "description": "App Configuration resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-appconfig'), '2025-04-01').outputs.appConfigId.value]"
    },
    "appConfigName": {
      "type": "string",
      "metadata": {
        "description": "App Configuration name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-appconfig'), '2025-04-01').outputs.appConfigName.value]"
    },
    "appConfigEndpoint": {
      "type": "string",
      "metadata": {
        "description": "App Configuration endpoint"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-appconfig'), '2025-04-01').outputs.appConfigEndpoint.value]"
    },
    "storageAccountId": {
      "type": "string",
      "metadata": {
        "description": "Storage account resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountId.value]"
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage account name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "mlModelsShareName": {
      "type": "string",
      "metadata": {
        "description": "ML models file share name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.mlModelsShareName.value]"
    },
    "acrId": {
      "type": "string",
      "metadata": {
        "description": "ACR resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-acr'), '2025-04-01').outputs.acrId.value]"
    },
    "acrLoginServer": {
      "type": "string",
      "metadata": {
        "description": "ACR login server"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-acr'), '2025-04-01').outputs.acrLoginServer.value]"
    },
    "mysqlServerId": {
      "type": "string",
      "metadata": {
        "description": "MySQL server resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mysql'), '2025-04-01').outputs.mysqlServerId.value]"
    },
    "mysqlServerFqdn": {
      "type": "string",
      "metadata": {
        "description": "MySQL server FQDN"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mysql'), '2025-04-01').outputs.mysqlServerFqdn.value]"
    },
    "redisId": {
      "type": "string",
      "metadata": {
        "description": "Redis cluster resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-redis'), '2025-04-01').outputs.redisId.value]"
    },
    "redisName": {
      "type": "string",
      "metadata": {
        "description": "Redis cluster name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-redis'), '2025-04-01').outputs.redisName.value]"
    },
    "redisHostName": {
      "type": "string",
      "metadata": {
        "description": "Redis host name (use with port 10000)"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-redis'), '2025-04-01').outputs.redisHostName.value]"
    },
    "aksClusterId": {
      "type": "string",
      "metadata": {
        "description": "AKS cluster resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.aksClusterId.value]"
    },
    "aksClusterName": {
      "type": "string",
      "metadata": {
        "description": "AKS cluster name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.aksClusterName.value]"
    },
    "aksClusterFqdn": {
      "type": "string",
      "metadata": {
        "description": "AKS cluster FQDN"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.aksClusterFqdn.value]"
    },
    "oidcIssuerUrl": {
      "type": "string",
      "metadata": {
        "description": "AKS OIDC Issuer URL (for federated credentials)"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.oidcIssuerUrl.value]"
    },
    "kubeletIdentityObjectId": {
      "type": "string",
      "metadata": {
        "description": "AKS kubelet identity object ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.kubeletIdentityObjectId.value]"
    },
    "kubeletIdentityClientId": {
      "type": "string",
      "metadata": {
        "description": "AKS kubelet identity client ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.kubeletIdentityClientId.value]"
    },
    "nodeResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "AKS node resource group (MC_ resource group)"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-aks'), '2025-04-01').outputs.nodeResourceGroup.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring'), '2025-04-01').outputs.workspaceId.value]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring'), '2025-04-01').outputs.workspaceName.value]"
    },
    "containerInsightsDcrId": {
      "type": "string",
      "metadata": {
        "description": "Container Insights DCR resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring'), '2025-04-01').outputs.dcrId.value]"
    },
    "appInsightsId": {
      "type": "string",
      "metadata": {
        "description": "Application Insights resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring'), '2025-04-01').outputs.appInsightsId.value]"
    },
    "appInsightsName": {
      "type": "string",
      "metadata": {
        "description": "Application Insights name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring'), '2025-04-01').outputs.appInsightsName.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Application Insights connection string"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-monitoring'), '2025-04-01').outputs.appInsightsConnectionString.value]"
    },
    "nginxIngressIp": {
      "type": "string",
      "metadata": {
        "description": "NGINX Ingress internal LoadBalancer IP"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-nginx-ingress'), '2025-04-01').outputs.loadBalancerIp.value]"
    },
    "privateLinkServiceId": {
      "type": "string",
      "metadata": {
        "description": "Private Link Service resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-link-service'), '2025-04-01').outputs.plsId.value]"
    },
    "privateLinkServiceName": {
      "type": "string",
      "metadata": {
        "description": "Private Link Service name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-private-link-service'), '2025-04-01').outputs.plsName.value]"
    },
    "frontDoorId": {
      "type": "string",
      "metadata": {
        "description": "Front Door profile resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-front-door'), '2025-04-01').outputs.frontDoorId.value]"
    },
    "frontDoorHostname": {
      "type": "string",
      "metadata": {
        "description": "Front Door endpoint hostname (configure CNAME: subdomain.university.edu  this)"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-front-door'), '2025-04-01').outputs.frontDoorEndpointHostname.value]"
    },
    "wafPolicyId": {
      "type": "string",
      "metadata": {
        "description": "WAF policy resource ID"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-front-door'), '2025-04-01').outputs.wafPolicyId.value]"
    },
    "dnsConfig": {
      "type": "string",
      "metadata": {
        "description": "DNS CNAME record IT must create (custom domain  Front Door hostname)"
      },
      "value": "[format('{0} CNAME {1}', parameters('customDomain'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-front-door'), '2025-04-01').outputs.frontDoorEndpointHostname.value)]"
    },
    "baseUrl": {
      "type": "string",
      "metadata": {
        "description": "Base URL for ConfigMap env vars (PUBLIC_URL, FRONTEND_URL, REACT_APP_SERVER_API_URL)"
      },
      "value": "[format('https://{0}', parameters('customDomain'))]"
    }
  }
}