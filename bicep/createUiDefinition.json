{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": true,
      "basics": {
        "description": "Deploy QWiser University learning platform infrastructure to Azure.",
        "subscription": {
          "resourceProviders": [
            "Microsoft.ContainerService",
            "Microsoft.Network",
            "Microsoft.Storage",
            "Microsoft.DBforMySQL",
            "Microsoft.Cache",
            "Microsoft.ContainerRegistry",
            "Microsoft.KeyVault",
            "Microsoft.App",
            "Microsoft.Cdn",
            "Microsoft.OperationalInsights",
            "Microsoft.Insights"
          ]
        },
        "resourceGroup": {
          "allowExisting": false
        },
        "location": {
          "label": "Region",
          "resourceTypes": [
            "Microsoft.ContainerService/managedClusters",
            "Microsoft.DBforMySQL/flexibleServers",
            "Microsoft.Cache/redisEnterprise"
          ]
        }
      }
    },
    "basics": [
      {
        "name": "environmentName",
        "type": "Microsoft.Common.TextBox",
        "label": "Environment Name",
        "toolTip": "Used for resource naming (e.g., prod, staging). Keep it short.",
        "placeholder": "prod",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^[a-z0-9]{1,10}$",
              "message": "Must be 1-10 lowercase alphanumeric characters."
            }
          ]
        }
      },
      {
        "name": "namePrefix",
        "type": "Microsoft.Common.TextBox",
        "label": "Resource Name Prefix",
        "defaultValue": "qwiser",
        "toolTip": "Prefix for all Azure resource names. Use your university abbreviation.",
        "placeholder": "qwiser",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^[a-z][a-z0-9-]{0,9}$",
              "message": "Must be 1-10 characters, start with a letter, lowercase alphanumeric and hyphens only."
            }
          ]
        }
      },
      {
        "name": "customDomain",
        "type": "Microsoft.Common.TextBox",
        "label": "Custom Domain",
        "toolTip": "The domain your university will point to this deployment (e.g., qwiser.university.edu). You'll create a CNAME record after deployment.",
        "placeholder": "qwiser.university.edu",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^[a-zA-Z0-9][a-zA-Z0-9.-]+[a-zA-Z0-9]$",
              "message": "Must be a valid domain name."
            }
          ]
        }
      },
      {
        "name": "tags",
        "type": "Microsoft.Common.TagsByResource",
        "resources": [
          "Microsoft.Resources/resourceGroups"
        ],
        "toolTip": "Tags to apply to all resources for cost tracking and organization."
      }
    ],
    "steps": [
      {
        "name": "database",
        "label": "Database",
        "elements": [
          {
            "name": "mysqlAvailabilityWarning",
            "type": "Microsoft.Common.InfoBox",
            "options": {
              "icon": "Warning",
              "text": "MySQL Flexible Server availability varies by region and subscription. Before deploying, verify availability: az mysql flexible-server list-skus --location <region> -o table"
            }
          },
          {
            "name": "mysqlSection",
            "type": "Microsoft.Common.Section",
            "label": "MySQL Configuration",
            "elements": [
              {
                "name": "mysqlAdminLogin",
                "type": "Microsoft.Common.TextBox",
                "label": "Administrator Login",
                "toolTip": "MySQL admin username. Cannot be 'admin', 'administrator', 'root', etc.",
                "placeholder": "qwiseradmin",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^[a-zA-Z][a-zA-Z0-9_]{2,63}$",
                      "message": "Must start with a letter, 3-64 characters, alphanumeric and underscores only."
                    },
                    {
                      "regex": "^(?!admin$|administrator$|root$|sa$|guest$|public$).*$",
                      "message": "Cannot use reserved names like admin, administrator, root, sa, guest, public."
                    }
                  ]
                }
              },
              {
                "name": "mysqlAdminPassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Administrator Password",
                  "confirmPassword": "Confirm Password"
                },
                "toolTip": "MySQL admin password. Must be at least 8 characters with uppercase, lowercase, and numbers.",
                "constraints": {
                  "required": true,
                  "validationMessage": "Password must be 8-128 characters with at least one uppercase, one lowercase, and one number."
                },
                "options": {
                  "hideConfirmation": false
                }
              },
              {
                "name": "mysqlSkuTier",
                "type": "Microsoft.Common.DropDown",
                "label": "SKU Tier",
                "defaultValue": "GeneralPurpose",
                "toolTip": "Burstable is cheapest but doesn't support HA. GeneralPurpose recommended for production.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "Burstable (Dev/Test)", "value": "Burstable" },
                    { "label": "General Purpose (Recommended)", "value": "GeneralPurpose" },
                    { "label": "Memory Optimized", "value": "MemoryOptimized" }
                  ]
                }
              },
              {
                "name": "mysqlSkuNameBurstable",
                "type": "Microsoft.Common.DropDown",
                "label": "SKU",
                "defaultValue": "Standard_B2ms",
                "visible": "[equals(steps('database').mysqlSection.mysqlSkuTier, 'Burstable')]",
                "toolTip": "Burstable VM size. B-series uses CPU credits.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "Standard_B1ms (1 vCPU, 2 GB)", "value": "Standard_B1ms" },
                    { "label": "Standard_B2s (2 vCPU, 4 GB)", "value": "Standard_B2s" },
                    { "label": "Standard_B2ms (2 vCPU, 8 GB) - Recommended", "value": "Standard_B2ms" },
                    { "label": "Standard_B4ms (4 vCPU, 16 GB)", "value": "Standard_B4ms" },
                    { "label": "Standard_B8ms (8 vCPU, 32 GB)", "value": "Standard_B8ms" }
                  ]
                }
              },
              {
                "name": "mysqlSkuNameGeneralPurpose",
                "type": "Microsoft.Common.DropDown",
                "label": "SKU",
                "defaultValue": "Standard_D2ds_v4",
                "visible": "[equals(steps('database').mysqlSection.mysqlSkuTier, 'GeneralPurpose')]",
                "toolTip": "General Purpose VM size. D-series for balanced compute.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "Standard_D2ds_v4 (2 vCPU, 8 GB) - Recommended", "value": "Standard_D2ds_v4" },
                    { "label": "Standard_D4ds_v4 (4 vCPU, 16 GB)", "value": "Standard_D4ds_v4" },
                    { "label": "Standard_D8ds_v4 (8 vCPU, 32 GB)", "value": "Standard_D8ds_v4" },
                    { "label": "Standard_D16ds_v4 (16 vCPU, 64 GB)", "value": "Standard_D16ds_v4" },
                    { "label": "Standard_D32ds_v4 (32 vCPU, 128 GB)", "value": "Standard_D32ds_v4" }
                  ]
                }
              },
              {
                "name": "mysqlSkuNameBusinessCritical",
                "type": "Microsoft.Common.DropDown",
                "label": "SKU",
                "defaultValue": "Standard_E2ds_v4",
                "visible": "[equals(steps('database').mysqlSection.mysqlSkuTier, 'MemoryOptimized')]",
                "toolTip": "Business Critical VM size. E-series for memory-intensive workloads.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "Standard_E2ds_v4 (2 vCPU, 16 GB)", "value": "Standard_E2ds_v4" },
                    { "label": "Standard_E4ds_v4 (4 vCPU, 32 GB)", "value": "Standard_E4ds_v4" },
                    { "label": "Standard_E8ds_v4 (8 vCPU, 64 GB)", "value": "Standard_E8ds_v4" },
                    { "label": "Standard_E16ds_v4 (16 vCPU, 128 GB)", "value": "Standard_E16ds_v4" },
                    { "label": "Standard_E32ds_v4 (32 vCPU, 256 GB)", "value": "Standard_E32ds_v4" }
                  ]
                }
              },
              {
                "name": "mysqlStorageSizeGB",
                "type": "Microsoft.Common.Slider",
                "label": "Storage Size (GB)",
                "defaultValue": 64,
                "min": 20,
                "max": 16384,
                "showStepMarkers": false,
                "toolTip": "Initial storage allocation. Can be increased later but not decreased."
              },
              {
                "name": "mysqlHaWarning",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('database').mysqlSection.mysqlSkuTier, 'Burstable'), not(equals(steps('database').mysqlSection.mysqlHighAvailabilityMode, 'Disabled')))]",
                "options": {
                  "icon": "Error",
                  "text": "Burstable tier does NOT support High Availability. Deployment will fail. Select 'Disabled' or change to GeneralPurpose/MemoryOptimized tier."
                }
              },
              {
                "name": "mysqlHighAvailabilityMode",
                "type": "Microsoft.Common.DropDown",
                "label": "High Availability",
                "defaultValue": "Disabled",
                "toolTip": "HA requires GeneralPurpose or MemoryOptimized tier. Burstable does NOT support HA.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "Disabled", "value": "Disabled" },
                    { "label": "Same Zone", "value": "SameZone" },
                    { "label": "Zone Redundant (Recommended for prod)", "value": "ZoneRedundant" }
                  ]
                }
              }
            ]
          },
          {
            "name": "redisSection",
            "type": "Microsoft.Common.Section",
            "label": "Redis Configuration",
            "elements": [
              {
                "name": "redisSkuName",
                "type": "Microsoft.Common.DropDown",
                "label": "SKU",
                "defaultValue": "Balanced_B5",
                "toolTip": "Redis cache size. Balanced tier recommended for QWiser workloads.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "Balanced_B0 (0.5 GB) - Dev/test", "value": "Balanced_B0" },
                    { "label": "Balanced_B1 (1 GB) - Dev/test", "value": "Balanced_B1" },
                    { "label": "Balanced_B3 (3 GB) - Small", "value": "Balanced_B3" },
                    { "label": "Balanced_B5 (5 GB) - Recommended", "value": "Balanced_B5" },
                    { "label": "Balanced_B10 (10 GB) - Medium", "value": "Balanced_B10" },
                    { "label": "Balanced_B20 (20 GB) - Large", "value": "Balanced_B20" }
                  ]
                }
              },
              {
                "name": "redisHighAvailability",
                "type": "Microsoft.Common.DropDown",
                "label": "High Availability",
                "defaultValue": "Enabled",
                "toolTip": "Enable HA for automatic failover. Recommended for production.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "Enabled (Recommended)", "value": "Enabled" },
                    { "label": "Disabled", "value": "Disabled" }
                  ]
                }
              },
              {
                "name": "redisZones",
                "type": "Microsoft.Common.TextBox",
                "label": "Availability Zones",
                "defaultValue": "",
                "toolTip": "Comma-separated zones (e.g., 1,2,3) for zone redundancy. Leave empty for no zone preference.",
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "enableRedisPublicAccess",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable public network access (for external embeddings-worker)",
                "toolTip": "Enable this ONLY if running embeddings-worker externally (e.g., in another subscription with GPU quota). Security is maintained via Entra ID authentication. Disable after testing.",
                "defaultValue": false
              }
            ]
          }
        ]
      },
      {
        "name": "compute",
        "label": "Compute",
        "elements": [
          {
            "name": "quotaWarning",
            "type": "Microsoft.Common.InfoBox",
            "options": {
              "icon": "Warning",
              "text": "Before deploying, verify you have sufficient VM quota in your target region. Required quotas: standardDSv5Family (12+ cores for AKS system nodes), standardNCASv3_T4Family (4+ cores for GPU nodes). Check quotas: Azure Portal → Quotas → Compute → Select region."
            }
          },
          {
            "name": "aksSection",
            "type": "Microsoft.Common.Section",
            "label": "Kubernetes (AKS) Configuration",
            "elements": [
              {
                "name": "kubernetesVersion",
                "type": "Microsoft.Common.TextBox",
                "label": "Kubernetes Version",
                "defaultValue": "",
                "toolTip": "Leave empty for latest stable version. Otherwise specify version like '1.29'.",
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "aksEnablePrivateCluster",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable Private Cluster",
                "defaultValue": true,
                "toolTip": "Recommended. API server only accessible via private network. Disable only if you need public kubectl access."
              },
              {
                "name": "aksAuthorizedIPRanges",
                "type": "Microsoft.Common.TextBox",
                "label": "Authorized IP Ranges",
                "defaultValue": "",
                "toolTip": "Only applies if private cluster is disabled. Comma-separated CIDRs allowed to reach API server.",
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "aksSystemNodeVmSize",
                "type": "Microsoft.Common.DropDown",
                "label": "System Node VM Size",
                "defaultValue": "Standard_D4s_v5",
                "toolTip": "VM size for AKS system nodes. Choose based on your quota availability. ARM64 (p-series) VMs are excluded as QWiser requires AMD64.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "── v6 Generation (Intel) ──", "value": "" },
                    { "label": "Standard_D2s_v6 (2 vCPU, 8GB)", "value": "Standard_D2s_v6" },
                    { "label": "Standard_D4s_v6 (4 vCPU, 16GB)", "value": "Standard_D4s_v6" },
                    { "label": "Standard_D8s_v6 (8 vCPU, 32GB)", "value": "Standard_D8s_v6" },
                    { "label": "Standard_D2ds_v6 (2 vCPU, 8GB, local SSD)", "value": "Standard_D2ds_v6" },
                    { "label": "Standard_D4ds_v6 (4 vCPU, 16GB, local SSD)", "value": "Standard_D4ds_v6" },
                    { "label": "Standard_D8ds_v6 (8 vCPU, 32GB, local SSD)", "value": "Standard_D8ds_v6" },
                    { "label": "── v6 Generation (AMD) ──", "value": "" },
                    { "label": "Standard_D2as_v6 (2 vCPU, 8GB)", "value": "Standard_D2as_v6" },
                    { "label": "Standard_D4as_v6 (4 vCPU, 16GB)", "value": "Standard_D4as_v6" },
                    { "label": "Standard_D8as_v6 (8 vCPU, 32GB)", "value": "Standard_D8as_v6" },
                    { "label": "Standard_D2ads_v6 (2 vCPU, 8GB, local SSD)", "value": "Standard_D2ads_v6" },
                    { "label": "Standard_D4ads_v6 (4 vCPU, 16GB, local SSD)", "value": "Standard_D4ads_v6" },
                    { "label": "Standard_D8ads_v6 (8 vCPU, 32GB, local SSD)", "value": "Standard_D8ads_v6" },
                    { "label": "── v5 Generation (Intel) - Recommended ──", "value": "" },
                    { "label": "Standard_D2s_v5 (2 vCPU, 8GB)", "value": "Standard_D2s_v5" },
                    { "label": "Standard_D4s_v5 (4 vCPU, 16GB) ★ Recommended", "value": "Standard_D4s_v5" },
                    { "label": "Standard_D8s_v5 (8 vCPU, 32GB)", "value": "Standard_D8s_v5" },
                    { "label": "Standard_D2ds_v5 (2 vCPU, 8GB, local SSD)", "value": "Standard_D2ds_v5" },
                    { "label": "Standard_D4ds_v5 (4 vCPU, 16GB, local SSD)", "value": "Standard_D4ds_v5" },
                    { "label": "Standard_D8ds_v5 (8 vCPU, 32GB, local SSD)", "value": "Standard_D8ds_v5" },
                    { "label": "Standard_D2ls_v5 (2 vCPU, 4GB, low memory)", "value": "Standard_D2ls_v5" },
                    { "label": "Standard_D4ls_v5 (4 vCPU, 8GB, low memory)", "value": "Standard_D4ls_v5" },
                    { "label": "Standard_D8ls_v5 (8 vCPU, 16GB, low memory)", "value": "Standard_D8ls_v5" },
                    { "label": "── v5 Generation (AMD) ──", "value": "" },
                    { "label": "Standard_D2as_v5 (2 vCPU, 8GB)", "value": "Standard_D2as_v5" },
                    { "label": "Standard_D4as_v5 (4 vCPU, 16GB)", "value": "Standard_D4as_v5" },
                    { "label": "Standard_D8as_v5 (8 vCPU, 32GB)", "value": "Standard_D8as_v5" },
                    { "label": "Standard_D2ads_v5 (2 vCPU, 8GB, local SSD)", "value": "Standard_D2ads_v5" },
                    { "label": "Standard_D4ads_v5 (4 vCPU, 16GB, local SSD)", "value": "Standard_D4ads_v5" },
                    { "label": "Standard_D8ads_v5 (8 vCPU, 32GB, local SSD)", "value": "Standard_D8ads_v5" },
                    { "label": "── v4 Generation (Intel) ──", "value": "" },
                    { "label": "Standard_D2s_v4 (2 vCPU, 8GB)", "value": "Standard_D2s_v4" },
                    { "label": "Standard_D4s_v4 (4 vCPU, 16GB)", "value": "Standard_D4s_v4" },
                    { "label": "Standard_D8s_v4 (8 vCPU, 32GB)", "value": "Standard_D8s_v4" },
                    { "label": "Standard_D2ds_v4 (2 vCPU, 8GB, local SSD)", "value": "Standard_D2ds_v4" },
                    { "label": "Standard_D4ds_v4 (4 vCPU, 16GB, local SSD)", "value": "Standard_D4ds_v4" },
                    { "label": "Standard_D8ds_v4 (8 vCPU, 32GB, local SSD)", "value": "Standard_D8ds_v4" },
                    { "label": "── v4 Generation (AMD) ──", "value": "" },
                    { "label": "Standard_D2as_v4 (2 vCPU, 8GB)", "value": "Standard_D2as_v4" },
                    { "label": "Standard_D4as_v4 (4 vCPU, 16GB)", "value": "Standard_D4as_v4" },
                    { "label": "Standard_D8as_v4 (8 vCPU, 32GB)", "value": "Standard_D8as_v4" },
                    { "label": "── v3 Generation (Intel) ──", "value": "" },
                    { "label": "Standard_D2s_v3 (2 vCPU, 8GB)", "value": "Standard_D2s_v3" },
                    { "label": "Standard_D4s_v3 (4 vCPU, 16GB)", "value": "Standard_D4s_v3" },
                    { "label": "Standard_D8s_v3 (8 vCPU, 32GB)", "value": "Standard_D8s_v3" },
                    { "label": "── v2 Generation (Intel) ──", "value": "" },
                    { "label": "Standard_DS2_v2 (2 vCPU, 7GB)", "value": "Standard_DS2_v2" },
                    { "label": "Standard_DS3_v2 (4 vCPU, 14GB)", "value": "Standard_DS3_v2" },
                    { "label": "Standard_DS4_v2 (8 vCPU, 28GB)", "value": "Standard_DS4_v2" }
                  ]
                }
              },
              {
                "name": "aksSystemNodeCount",
                "type": "Microsoft.Common.Slider",
                "label": "Initial Node Count",
                "defaultValue": 3,
                "min": 2,
                "max": 10,
                "showStepMarkers": true,
                "toolTip": "Initial number of nodes. 3 recommended for HA across availability zones."
              },
              {
                "name": "aksSystemNodeMinCount",
                "type": "Microsoft.Common.Slider",
                "label": "Minimum Node Count (Autoscaling)",
                "defaultValue": 2,
                "min": 1,
                "max": 10,
                "showStepMarkers": true,
                "toolTip": "Minimum nodes for autoscaler. At least 2 recommended for availability."
              },
              {
                "name": "aksSystemNodeMaxCount",
                "type": "Microsoft.Common.Slider",
                "label": "Maximum Node Count (Autoscaling)",
                "defaultValue": 10,
                "min": 3,
                "max": 50,
                "showStepMarkers": false,
                "toolTip": "Maximum nodes for autoscaler. Set based on expected peak usage."
              }
            ]
          },
          {
            "name": "gpuSection",
            "type": "Microsoft.Common.Section",
            "label": "GPU Node Pool",
            "elements": [
              {
                "name": "deployGpuNodePool",
                "type": "Microsoft.Common.CheckBox",
                "label": "Deploy GPU node pool for embeddings-worker",
                "toolTip": "Uncheck if GPU quota is unavailable. You can run embeddings-worker externally (e.g., in another subscription with GPU quota) by enabling Redis public access in the Database step.",
                "defaultValue": true
              },
              {
                "name": "gpuNodeVmSize",
                "type": "Microsoft.Common.DropDown",
                "label": "GPU VM Size",
                "defaultValue": "Standard_NC4as_T4_v3",
                "visible": "[steps('compute').gpuSection.deployGpuNodePool]",
                "toolTip": "VM size for GPU nodes. Required for embeddings worker. Choose based on quota availability and performance needs.",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    { "label": "── NCasT4_v3 (NVIDIA T4) - Recommended ──", "value": "" },
                    { "label": "Standard_NC4as_T4_v3 (4 vCPU, 28GB, 1x T4 16GB) ★ Recommended", "value": "Standard_NC4as_T4_v3" },
                    { "label": "Standard_NC8as_T4_v3 (8 vCPU, 56GB, 1x T4 16GB)", "value": "Standard_NC8as_T4_v3" },
                    { "label": "Standard_NC16as_T4_v3 (16 vCPU, 110GB, 1x T4 16GB)", "value": "Standard_NC16as_T4_v3" },
                    { "label": "Standard_NC64as_T4_v3 (64 vCPU, 440GB, 4x T4 64GB)", "value": "Standard_NC64as_T4_v3" },
                    { "label": "── NCv3 (NVIDIA V100) ──", "value": "" },
                    { "label": "Standard_NC6s_v3 (6 vCPU, 112GB, 1x V100 16GB)", "value": "Standard_NC6s_v3" },
                    { "label": "Standard_NC12s_v3 (12 vCPU, 224GB, 2x V100 32GB)", "value": "Standard_NC12s_v3" },
                    { "label": "Standard_NC24s_v3 (24 vCPU, 448GB, 4x V100 64GB)", "value": "Standard_NC24s_v3" },
                    { "label": "── NC_A100_v4 (NVIDIA A100) ──", "value": "" },
                    { "label": "Standard_NC24ads_A100_v4 (24 vCPU, 220GB, 1x A100 80GB)", "value": "Standard_NC24ads_A100_v4" },
                    { "label": "Standard_NC48ads_A100_v4 (48 vCPU, 440GB, 2x A100 160GB)", "value": "Standard_NC48ads_A100_v4" },
                    { "label": "Standard_NC96ads_A100_v4 (96 vCPU, 880GB, 4x A100 320GB)", "value": "Standard_NC96ads_A100_v4" },
                    { "label": "── NCads_H100_v5 (NVIDIA H100) ──", "value": "" },
                    { "label": "Standard_NC40ads_H100_v5 (40 vCPU, 320GB, 1x H100 80GB)", "value": "Standard_NC40ads_H100_v5" },
                    { "label": "Standard_NC80adis_H100_v5 (80 vCPU, 640GB, 2x H100 160GB)", "value": "Standard_NC80adis_H100_v5" },
                    { "label": "── NVadsA10_v5 (NVIDIA A10) ──", "value": "" },
                    { "label": "Standard_NV6ads_A10_v5 (6 vCPU, 55GB, 1/6x A10 4GB)", "value": "Standard_NV6ads_A10_v5" },
                    { "label": "Standard_NV12ads_A10_v5 (12 vCPU, 110GB, 1/3x A10 8GB)", "value": "Standard_NV12ads_A10_v5" },
                    { "label": "Standard_NV18ads_A10_v5 (18 vCPU, 220GB, 1/2x A10 12GB)", "value": "Standard_NV18ads_A10_v5" },
                    { "label": "Standard_NV36ads_A10_v5 (36 vCPU, 440GB, 1x A10 24GB)", "value": "Standard_NV36ads_A10_v5" },
                    { "label": "Standard_NV36adms_A10_v5 (36 vCPU, 880GB, 1x A10 24GB)", "value": "Standard_NV36adms_A10_v5" },
                    { "label": "Standard_NV72ads_A10_v5 (72 vCPU, 880GB, 2x A10 48GB)", "value": "Standard_NV72ads_A10_v5" },
                    { "label": "── NVSv4 (AMD Radeon MI25) ──", "value": "" },
                    { "label": "Standard_NV4as_v4 (4 vCPU, 14GB, 1/8x MI25 2GB)", "value": "Standard_NV4as_v4" },
                    { "label": "Standard_NV8as_v4 (8 vCPU, 28GB, 1/4x MI25 4GB)", "value": "Standard_NV8as_v4" },
                    { "label": "Standard_NV16as_v4 (16 vCPU, 56GB, 1/2x MI25 8GB)", "value": "Standard_NV16as_v4" },
                    { "label": "Standard_NV32as_v4 (32 vCPU, 112GB, 1x MI25 16GB)", "value": "Standard_NV32as_v4" },
                    { "label": "── NC-series (NVIDIA K80) - Legacy ──", "value": "" },
                    { "label": "Standard_NC6 (6 vCPU, 56GB, 1x K80 12GB)", "value": "Standard_NC6" },
                    { "label": "Standard_NC12 (12 vCPU, 112GB, 2x K80 24GB)", "value": "Standard_NC12" },
                    { "label": "Standard_NC24 (24 vCPU, 224GB, 4x K80 48GB)", "value": "Standard_NC24" },
                    { "label": "── NV-series (NVIDIA M60) - Legacy ──", "value": "" },
                    { "label": "Standard_NV6 (6 vCPU, 56GB, 1x M60 8GB)", "value": "Standard_NV6" },
                    { "label": "Standard_NV12 (12 vCPU, 112GB, 2x M60 16GB)", "value": "Standard_NV12" },
                    { "label": "Standard_NV24 (24 vCPU, 224GB, 4x M60 32GB)", "value": "Standard_NV24" }
                  ]
                }
              }
            ]
          }
        ]
      },
      {
        "name": "security",
        "label": "Security",
        "elements": [
          {
            "name": "storageSection",
            "type": "Microsoft.Common.Section",
            "label": "Storage Security",
            "elements": [
              {
                "name": "storageAllowSharedKeyAccess",
                "type": "Microsoft.Common.CheckBox",
                "label": "Allow Storage Shared Key Access",
                "defaultValue": true,
                "toolTip": "Enable for simpler IT uploads to ML models file share. Disable for Entra ID-only authentication (more secure but requires RBAC setup)."
              }
            ]
          },
          {
            "name": "wafSection",
            "type": "Microsoft.Common.Section",
            "label": "Web Application Firewall",
            "elements": [
              {
                "name": "enableWaf",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable WAF on Front Door",
                "defaultValue": true,
                "toolTip": "Recommended. Protects against OWASP Top 10 attacks, bots, and DDoS."
              },
              {
                "name": "wafMode",
                "type": "Microsoft.Common.DropDown",
                "label": "WAF Mode",
                "defaultValue": "Prevention",
                "visible": "[steps('security').wafSection.enableWaf]",
                "toolTip": "Detection mode logs but doesn't block. Use Prevention for production.",
                "constraints": {
                  "required": false,
                  "allowedValues": [
                    { "label": "Detection (Log only)", "value": "Detection" },
                    { "label": "Prevention (Block attacks)", "value": "Prevention" }
                  ]
                }
              }
            ]
          },
          {
            "name": "workloadSection",
            "type": "Microsoft.Common.Section",
            "label": "Workload Identity",
            "elements": [
              {
                "name": "workloadNamespace",
                "type": "Microsoft.Common.TextBox",
                "label": "Kubernetes Namespace",
                "defaultValue": "default",
                "toolTip": "Kubernetes namespace where QWiser services will be deployed. Federated credentials are bound to this namespace.",
                "constraints": {
                  "required": true
                }
              }
            ]
          }
        ]
      },
      {
        "name": "networking",
        "label": "Networking (Advanced)",
        "elements": [
          {
            "name": "networkingInfo",
            "type": "Microsoft.Common.InfoBox",
            "options": {
              "icon": "Info",
              "text": "Default values use 10.200.x.x range to minimize overlap with common enterprise networks. Only change if these ranges conflict with existing campus or peered Azure networks."
            }
          },
          {
            "name": "vnetSection",
            "type": "Microsoft.Common.Section",
            "label": "Virtual Network",
            "elements": [
              {
                "name": "vnetAddressPrefix",
                "type": "Microsoft.Common.TextBox",
                "label": "VNet Address Space",
                "defaultValue": "10.200.0.0/16",
                "toolTip": "Virtual network CIDR block. Provides 65,536 IP addresses. Change if this overlaps with existing networks.",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
                      "message": "Must be a valid CIDR notation (e.g., 10.200.0.0/16)."
                    }
                  ]
                }
              },
              {
                "name": "peSubnetPrefix",
                "type": "Microsoft.Common.TextBox",
                "label": "Private Endpoints Subnet",
                "defaultValue": "10.200.0.0/24",
                "toolTip": "Subnet for Azure PaaS private endpoints. Uses ~11 IPs currently. /24 provides ample headroom.",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
                      "message": "Must be a valid CIDR notation (e.g., 10.200.0.0/24)."
                    }
                  ]
                }
              },
              {
                "name": "aksNodesSubnetPrefix",
                "type": "Microsoft.Common.TextBox",
                "label": "AKS Nodes Subnet",
                "defaultValue": "10.200.4.0/22",
                "toolTip": "Subnet for Kubernetes worker nodes. /22 provides 1024 IPs for cluster autoscaling.",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
                      "message": "Must be a valid CIDR notation (e.g., 10.200.4.0/22)."
                    }
                  ]
                }
              },
              {
                "name": "aciSubnetPrefix",
                "type": "Microsoft.Common.TextBox",
                "label": "Deployment Scripts Subnet",
                "defaultValue": "10.200.8.0/27",
                "toolTip": "Subnet for deployment script containers (ACI). /27 provides 32 IPs, only used during deployment.",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
                      "message": "Must be a valid CIDR notation (e.g., 10.200.8.0/27)."
                    }
                  ]
                }
              }
            ]
          },
          {
            "name": "podNetworkSection",
            "type": "Microsoft.Common.Section",
            "label": "Pod Networking",
            "elements": [
              {
                "name": "aksPodCidr",
                "type": "Microsoft.Common.TextBox",
                "label": "Pod CIDR",
                "defaultValue": "100.64.0.0/16",
                "toolTip": "Internal address range for Kubernetes pods (Azure CNI Overlay). Uses CGNAT range which is unlikely to conflict with campus networks.",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$",
                      "message": "Must be a valid CIDR notation (e.g., 100.64.0.0/16)."
                    }
                  ]
                }
              },
              {
                "name": "nginxIngressPrivateIp",
                "type": "Microsoft.Common.TextBox",
                "label": "Ingress Load Balancer IP",
                "defaultValue": "10.200.4.250",
                "toolTip": "Static IP for the internal load balancer. Must be within the AKS nodes subnet range.",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}$",
                      "message": "Must be a valid IP address (e.g., 10.200.4.250)."
                    }
                  ]
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "environmentName": "[basics('environmentName')]",
      "namePrefix": "[basics('namePrefix')]",
      "customDomain": "[basics('customDomain')]",
      "tags": "[basics('tags')]",
      "mysqlAdminLogin": "[steps('database').mysqlSection.mysqlAdminLogin]",
      "mysqlAdminPassword": "[steps('database').mysqlSection.mysqlAdminPassword]",
      "mysqlSkuTier": "[steps('database').mysqlSection.mysqlSkuTier]",
      "mysqlSkuName": "[if(equals(steps('database').mysqlSection.mysqlSkuTier, 'Burstable'), steps('database').mysqlSection.mysqlSkuNameBurstable, if(equals(steps('database').mysqlSection.mysqlSkuTier, 'GeneralPurpose'), steps('database').mysqlSection.mysqlSkuNameGeneralPurpose, steps('database').mysqlSection.mysqlSkuNameBusinessCritical))]",
      "mysqlStorageSizeGB": "[steps('database').mysqlSection.mysqlStorageSizeGB]",
      "mysqlHighAvailabilityMode": "[steps('database').mysqlSection.mysqlHighAvailabilityMode]",
      "redisSkuName": "[steps('database').redisSection.redisSkuName]",
      "redisHighAvailability": "[steps('database').redisSection.redisHighAvailability]",
      "redisZones": "[if(empty(steps('database').redisSection.redisZones), parse('[]'), split(steps('database').redisSection.redisZones, ','))]",
      "enableRedisPublicAccess": "[steps('database').redisSection.enableRedisPublicAccess]",
      "kubernetesVersion": "[steps('compute').aksSection.kubernetesVersion]",
      "aksEnablePrivateCluster": "[steps('compute').aksSection.aksEnablePrivateCluster]",
      "aksAuthorizedIPRanges": "[if(empty(steps('compute').aksSection.aksAuthorizedIPRanges), parse('[]'), split(steps('compute').aksSection.aksAuthorizedIPRanges, ','))]",
      "aksSystemNodeVmSize": "[steps('compute').aksSection.aksSystemNodeVmSize]",
      "aksSystemNodeCount": "[steps('compute').aksSection.aksSystemNodeCount]",
      "aksSystemNodeMinCount": "[steps('compute').aksSection.aksSystemNodeMinCount]",
      "aksSystemNodeMaxCount": "[steps('compute').aksSection.aksSystemNodeMaxCount]",
      "deployGpuNodePool": "[steps('compute').gpuSection.deployGpuNodePool]",
      "gpuNodeVmSize": "[steps('compute').gpuSection.gpuNodeVmSize]",
      "storageAllowSharedKeyAccess": "[steps('security').storageSection.storageAllowSharedKeyAccess]",
      "enableWaf": "[steps('security').wafSection.enableWaf]",
      "wafMode": "[steps('security').wafSection.wafMode]",
      "workloadNamespace": "[steps('security').workloadSection.workloadNamespace]",
      "vnetAddressPrefix": "[steps('networking').vnetSection.vnetAddressPrefix]",
      "peSubnetPrefix": "[steps('networking').vnetSection.peSubnetPrefix]",
      "aksNodesSubnetPrefix": "[steps('networking').vnetSection.aksNodesSubnetPrefix]",
      "aciSubnetPrefix": "[steps('networking').vnetSection.aciSubnetPrefix]",
      "aksPodCidr": "[steps('networking').podNetworkSection.aksPodCidr]",
      "nginxIngressPrivateIp": "[steps('networking').podNetworkSection.nginxIngressPrivateIp]"
    }
  }
}
